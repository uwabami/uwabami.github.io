<!doctype html>
<html ⚡ lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="preconnect dns-prefetch" href="//cdn.ampproject.org" crossorigin>
    <link rel="preconnect dns-prefetch" href="//uwabami.github.io/" crossorigin>
    <!-- amp preload -->
    <link rel="preload" as="script" href="https://cdn.ampproject.org/v0.js">
    <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/ComicNeueSubset.woff2" crossorigin>
    <!-- end amp preload -->
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script async custom-element="amp-geo" src="https://cdn.ampproject.org/v0/amp-geo-0.1.js"></script>
    <script async custom-element="amp-consent" src="https://cdn.ampproject.org/v0/amp-consent-0.1.js"></script>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-form" src="https://cdn.ampproject.org/v0/amp-form-0.1.js"></script>
    <style amp-custom>:root{--font-family: sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", Symbola;--line-height: 1.5;--font-weight: 400;--font-size: 16px;--border-radius: 0.25rem;--border-width: 1px;--outline-width: 3px;--spacing: 1rem;--typography-spacing-vertical: 1.5rem;--block-spacing-vertical: calc(var(--spacing) * 2);--block-spacing-horizontal: var(--spacing);--grid-spacing-vertical: 0;--grid-spacing-horizontal: var(--spacing);--form-element-spacing-vertical: 0.75rem;--form-element-spacing-horizontal: 1rem;--nav-element-spacing-vertical: 1rem;--nav-element-spacing-horizontal: 0.5rem;--nav-link-spacing-vertical: 0.5rem;--nav-link-spacing-horizontal: 0.5rem;--form-label-font-weight: var(--font-weight);--transition: 0.2s ease-in-out;--modal-overlay-backdrop-filter: blur(0.25rem)}@media(min-width: 576px){:root{--font-size: 17px}}@media(min-width: 768px){:root{--font-size: 18px}}@media(min-width: 992px){:root{--font-size: 19px}}@media(min-width: 1200px){:root{--font-size: 20px}}@media(min-width: 576px){body>header,body>main,body>footer,section{--block-spacing-vertical: calc(var(--spacing) * 2.5)}}@media(min-width: 768px){body>header,body>main,body>footer,section{--block-spacing-vertical: calc(var(--spacing) * 3)}}@media(min-width: 992px){body>header,body>main,body>footer,section{--block-spacing-vertical: calc(var(--spacing) * 3.5)}}@media(min-width: 1200px){body>header,body>main,body>footer,section{--block-spacing-vertical: calc(var(--spacing) * 4)}}@media(min-width: 576px){article{--block-spacing-horizontal: calc(var(--spacing) * 1.25)}}@media(min-width: 768px){article{--block-spacing-horizontal: calc(var(--spacing) * 1.5)}}@media(min-width: 992px){article{--block-spacing-horizontal: calc(var(--spacing) * 1.75)}}@media(min-width: 1200px){article{--block-spacing-horizontal: calc(var(--spacing) * 2)}}dialog>article{--block-spacing-vertical: calc(var(--spacing) * 2);--block-spacing-horizontal: var(--spacing)}@media(min-width: 576px){dialog>article{--block-spacing-vertical: calc(var(--spacing) * 2.5);--block-spacing-horizontal: calc(var(--spacing) * 1.25)}}@media(min-width: 768px){dialog>article{--block-spacing-vertical: calc(var(--spacing) * 3);--block-spacing-horizontal: calc(var(--spacing) * 1.5)}}a{--text-decoration: none}a.secondary,a.contrast{--text-decoration: underline}small{--font-size: 0.875em}h1,h2,h3,h4,h5,h6{--font-weight: normal}h1{--font-size: 2rem}h2{--font-size: 1.75rem;border-bottom:1px solid #5af;font-weight:normal;padding:0;margin:1rem 0 0 0}h3{--font-size: 1.5rem;border-bottom:1px dashed #5af;font-weight:normal;margin:1rem 0 0 0}h4{--font-size: 1.25rem;border-bottom:1px dotted #5af;font-weight:normal;margin:1rem 0 0 0}h5{--font-size: 1.125rem;border-bottom:1px dashed #333;font-weight:normal;margin:1rem 0 0 0}h6{--font-size: 1.05rem;border-bottom:1px dashed #333;font-weight:normal;margin:1rem 0 0 0}strong{font-weight:normal;font-size:1.75em}[type=checkbox],[type=radio]{--border-width: 2px}[type=checkbox][role=switch]{--border-width: 3px}thead th,thead td,tfoot th,tfoot td{--border-width: 3px}:not(thead,tfoot)>*>td{--font-size: 0.875em}pre,code,kbd,samp{--font-family: "Menlo", "Cascadia", "Cascadia Code", "Cascadia Mono", "Consolas", "Monaco", monospace, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", Symbola}kbd{--font-weight: bolder}:root{--background-color: #fff;--color: hsl(205, 20%, 32%);--h1-color: hsl(205, 30%, 15%);--h2-color: #24333e;--h3-color: hsl(205, 25%, 23%);--h4-color: #374956;--h5-color: hsl(205, 20%, 32%);--h6-color: #4d606d;--muted-color: hsl(205, 10%, 50%);--muted-border-color: hsl(205, 20%, 94%);--primary: hsl(195, 85%, 41%);--primary-hover: hsl(195, 90%, 32%);--primary-focus: rgba(16, 149, 193, 0.125);--primary-inverse: #fff;--secondary: hsl(205, 15%, 41%);--secondary-hover: hsl(205, 20%, 32%);--secondary-focus: rgba(89, 107, 120, 0.125);--secondary-inverse: #fff;--contrast: hsl(205, 30%, 15%);--contrast-hover: #000;--contrast-focus: rgba(89, 107, 120, 0.125);--contrast-inverse: #fff;--mark-background-color: #fff2ca;--mark-color: #543a26;--ins-color: #388e3c;--del-color: #c62828;--blockquote-border-color: var(--muted-border-color);--blockquote-footer-color: var(--muted-color);--button-box-shadow: 0 0 0 rgba(0, 0, 0, 0);--button-hover-box-shadow: 0 0 0 rgba(0, 0, 0, 0);--form-element-background-color: transparent;--form-element-border-color: hsl(205, 14%, 68%);--form-element-color: var(--color);--form-element-placeholder-color: var(--muted-color);--form-element-active-background-color: transparent;--form-element-active-border-color: var(--primary);--form-element-focus-color: var(--primary-focus);--form-element-disabled-background-color: hsl(205, 18%, 86%);--form-element-disabled-border-color: hsl(205, 14%, 68%);--form-element-disabled-opacity: 0.5;--form-element-invalid-border-color: #c62828;--form-element-invalid-active-border-color: #d32f2f;--form-element-invalid-focus-color: rgba(211, 47, 47, 0.125);--form-element-valid-border-color: #388e3c;--form-element-valid-active-border-color: #43a047;--form-element-valid-focus-color: rgba(67, 160, 71, 0.125);--switch-background-color: hsl(205, 16%, 77%);--switch-color: var(--primary-inverse);--switch-checked-background-color: var(--primary);--range-border-color: hsl(205, 18%, 86%);--range-active-border-color: hsl(205, 16%, 77%);--range-thumb-border-color: var(--background-color);--range-thumb-color: var(--secondary);--range-thumb-hover-color: var(--secondary-hover);--range-thumb-active-color: var(--primary);--table-border-color: var(--muted-border-color);--table-row-stripped-background-color: #f6f8f9;--code-background-color: hsl(210, 28%, 97%);--code-color: var(--muted-color);--code-kbd-background-color: var(--contrast);--code-kbd-color: var(--contrast-inverse);--code-tag-color: hsl(330, 40%, 50%);--code-property-color: hsl(185, 40%, 40%);--code-value-color: hsl(40, 20%, 50%);--code-comment-color: hsl(205, 14%, 68%);--accordion-border-color: var(--muted-border-color);--accordion-close-summary-color: var(--color);--accordion-open-summary-color: var(--muted-color);--card-background-color: var(--background-color);--card-border-color: var(--muted-border-color);--card-box-shadow: 0.0145rem 0.029rem 0.174rem rgba(27, 40, 50, 0.01698), 0.0335rem 0.067rem 0.402rem rgba(27, 40, 50, 0.024), 0.0625rem 0.125rem 0.75rem rgba(27, 40, 50, 0.03), 0.1125rem 0.225rem 1.35rem rgba(27, 40, 50, 0.036), 0.2085rem 0.417rem 2.502rem rgba(27, 40, 50, 0.04302), 0.5rem 1rem 6rem rgba(27, 40, 50, 0.06), 0 0 0 0.0625rem rgba(27, 40, 50, 0.015);--card-sectionning-background-color: #fbfbfc;--dropdown-background-color: #fbfbfc;--dropdown-border-color: #e1e6eb;--dropdown-box-shadow: var(--card-box-shadow);--dropdown-color: var(--color);--dropdown-hover-background-color: hsl(205, 20%, 94%);--modal-overlay-background-color: rgba(213, 220, 226, 0.7);--progress-background-color: hsl(205, 18%, 86%);--progress-color: var(--primary);--loading-spinner-opacity: 0.5;--tooltip-background-color: var(--contrast);--tooltip-color: var(--contrast-inverse)}progress,[type=checkbox],[type=radio],[type=range]{accent-color:var(--primary)}*,*::before,*::after{box-sizing:border-box;background-repeat:no-repeat}::before,::after{text-decoration:inherit;vertical-align:inherit}:where(:root){-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-text-size-adjust:100%;text-size-adjust:100%;background-color:var(--background-color);color:var(--color);font-weight:var(--font-weight);font-size:var(--font-size);line-height:var(--line-height);font-family:var(--font-family);text-rendering:optimizeLegibility;overflow-wrap:break-word;cursor:default;tab-size:4}main{display:block}body{width:100%;margin:0}body>header,body>main,body>footer{width:100%;margin-right:auto;margin-left:auto;padding:var(--block-spacing-vertical) 0}.container,.container-fluid{width:100%;margin-right:auto;margin-left:auto;padding-right:var(--spacing);padding-left:var(--spacing)}@media(min-width: 576px){.container{max-width:510px;padding-right:0;padding-left:0}}@media(min-width: 768px){.container{max-width:700px}}@media(min-width: 992px){.container{max-width:920px}}@media(min-width: 1200px){.container{max-width:1130px}}section{margin-bottom:var(--block-spacing-vertical)}.grid{grid-column-gap:var(--grid-spacing-horizontal);grid-row-gap:var(--grid-spacing-vertical);display:grid;grid-template-columns:1fr;margin:0}@media(min-width: 992px){.grid{grid-template-columns:repeat(auto-fit, minmax(0%, 1fr))}}.grid>*{min-width:0}figure{display:block;margin:0;padding:0;overflow-x:auto}figure figcaption{padding:calc(var(--spacing)*.5) 0;color:var(--muted-color)}b,strong{font-weight:bolder}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}address,blockquote,dl,figure,form,ol,p,pre,table,ul{margin-top:0;margin-bottom:var(--typography-spacing-vertical);color:var(--color);font-style:normal;font-weight:var(--font-weight);font-size:var(--font-size)}a,[role=link]{--color: var(--primary);--background-color: transparent;outline:none;background-color:var(--background-color);color:var(--color);text-decoration:var(--text-decoration);transition:background-color var(--transition),color var(--transition),text-decoration var(--transition),box-shadow var(--transition)}a:is([aria-current],:hover,:active,:focus),[role=link]:is([aria-current],:hover,:active,:focus){--color: var(--primary-hover);--text-decoration: underline}a:focus,[role=link]:focus{--background-color: var(--primary-focus)}a.secondary,[role=link].secondary{--color: var(--secondary)}a.secondary:is([aria-current],:hover,:active,:focus),[role=link].secondary:is([aria-current],:hover,:active,:focus){--color: var(--secondary-hover)}a.secondary:focus,[role=link].secondary:focus{--background-color: var(--secondary-focus)}a.contrast,[role=link].contrast{--color: var(--contrast)}a.contrast:is([aria-current],:hover,:active,:focus),[role=link].contrast:is([aria-current],:hover,:active,:focus){--color: var(--contrast-hover)}a.contrast:focus,[role=link].contrast:focus{--background-color: var(--contrast-focus)}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:var(--typography-spacing-vertical);color:var(--color);font-weight:var(--font-weight);font-size:var(--font-size);font-family:var(--font-family)}h1{--color: var(--h1-color)}h2{--color: var(--h2-color)}h3{--color: var(--h3-color)}h4{--color: var(--h4-color)}h5{--color: var(--h5-color)}h6{--color: var(--h6-color)}:where(address,blockquote,dl,figure,form,ol,p,pre,table,ul)~:is(h1,h2,h3,h4,h5,h6){margin-top:var(--typography-spacing-vertical)}hgroup,.headings{margin-bottom:var(--typography-spacing-vertical)}hgroup>*,.headings>*{margin-bottom:0}hgroup>*:last-child,.headings>*:last-child{--color: var(--muted-color);--font-weight: unset;font-size:1rem;font-family:unset}p{margin-bottom:var(--typography-spacing-vertical)}small{font-size:var(--font-size)}:where(dl,ol,ul){padding-right:0;padding-left:var(--spacing);padding-inline-start:var(--spacing);padding-inline-end:0}:where(dl,ol,ul) li{margin-bottom:calc(var(--typography-spacing-vertical)*.25)}:where(dl,ol,ul) :is(dl,ol,ul){margin:0;margin-top:calc(var(--typography-spacing-vertical)*.25)}ul li{list-style:square}mark{padding:.125rem .25rem;background-color:var(--mark-background-color);color:var(--mark-color);vertical-align:baseline}blockquote{display:block;margin:var(--typography-spacing-vertical) 0;padding:var(--spacing);border-right:none;border-left:.25rem solid var(--blockquote-border-color);border-inline-start:.25rem solid var(--blockquote-border-color);border-inline-end:none}blockquote footer{margin-top:calc(var(--typography-spacing-vertical)*.5);color:var(--blockquote-footer-color)}abbr[title]{border-bottom:1px dotted;text-decoration:none;cursor:help}ins{color:var(--ins-color);text-decoration:none}del{color:var(--del-color)}::selection{background-color:var(--primary-focus)}ul li{list-style:disc}dl{padding-left:0px}dd{margin-left:1rem}input,optgroup,select,textarea{margin:0;font-size:1rem;line-height:var(--line-height);font-family:inherit;letter-spacing:inherit}input{overflow:visible}select{text-transform:none}legend{max-width:100%;padding:0;color:inherit;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{padding:0}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}::-moz-focus-inner{padding:0;border-style:none}:-moz-focusring{outline:none}:-moz-ui-invalid{box-shadow:none}::-ms-expand{display:none}[type=file],[type=range]{padding:0;border-width:0}input:not([type=checkbox],[type=radio],[type=range]){height:calc(1rem*var(--line-height) + var(--form-element-spacing-vertical)*2 + var(--border-width)*2)}fieldset{margin:0;margin-bottom:var(--spacing);padding:0;border:0}label,fieldset legend{display:block;margin-bottom:calc(var(--spacing)*.25);font-weight:var(--form-label-font-weight, var(--font-weight))}input:not([type=checkbox],[type=radio]),select,textarea{width:100%}input:not([type=checkbox],[type=radio],[type=range],[type=file]),select,textarea{appearance:none;padding:var(--form-element-spacing-vertical) var(--form-element-spacing-horizontal)}input,select,textarea{--background-color: var(--form-element-background-color);--border-color: var(--form-element-border-color);--color: var(--form-element-color);--box-shadow: none;border:var(--border-width) solid var(--border-color);border-radius:var(--border-radius);outline:none;background-color:var(--background-color);box-shadow:var(--box-shadow);color:var(--color);font-weight:var(--font-weight);transition:background-color var(--transition),border-color var(--transition),color var(--transition),box-shadow var(--transition)}input:not([type=submit],[type=button],[type=reset],[type=checkbox],[type=radio],[readonly]):is(:active,:focus),:where(select,textarea):is(:active,:focus){--background-color: var(--form-element-active-background-color)}input:not([type=submit],[type=button],[type=reset],[role=switch],[readonly]):is(:active,:focus),:where(select,textarea):is(:active,:focus){--border-color: var(--form-element-active-border-color)}input:not([type=submit],[type=button],[type=reset],[type=range],[type=file],[readonly]):focus,select:focus,textarea:focus{--box-shadow: 0 0 0 var(--outline-width) var(--form-element-focus-color)}input:not([type=submit],[type=button],[type=reset])[disabled],select[disabled],textarea[disabled],:where(fieldset[disabled]) :is(input:not([type=submit],[type=button],[type=reset]),select,textarea){--background-color: var(--form-element-disabled-background-color);--border-color: var(--form-element-disabled-border-color);opacity:var(--form-element-disabled-opacity);pointer-events:none}:where(input,select,textarea):not([type=checkbox],[type=radio],[type=date],[type=datetime-local],[type=month],[type=time],[type=week])[aria-invalid]{padding-right:calc(var(--form-element-spacing-horizontal) + 1.5rem);padding-left:var(--form-element-spacing-horizontal);padding-inline-start:var(--form-element-spacing-horizontal);padding-inline-end:calc(var(--form-element-spacing-horizontal) + 1.5rem);background-position:center right .75rem;background-size:1rem auto;background-repeat:no-repeat}:where(input,select,textarea):not([type=checkbox],[type=radio],[type=date],[type=datetime-local],[type=month],[type=time],[type=week])[aria-invalid=false]{background-image:var(--icon-valid)}:where(input,select,textarea):not([type=checkbox],[type=radio],[type=date],[type=datetime-local],[type=month],[type=time],[type=week])[aria-invalid=true]{background-image:var(--icon-invalid)}:where(input,select,textarea)[aria-invalid=false]{--border-color: var(--form-element-valid-border-color)}:where(input,select,textarea)[aria-invalid=false]:is(:active,:focus){--border-color: var(--form-element-valid-active-border-color);--box-shadow: 0 0 0 var(--outline-width) var(--form-element-valid-focus-color)}:where(input,select,textarea)[aria-invalid=true]{--border-color: var(--form-element-invalid-border-color)}:where(input,select,textarea)[aria-invalid=true]:is(:active,:focus){--border-color: var(--form-element-invalid-active-border-color);--box-shadow: 0 0 0 var(--outline-width) var(--form-element-invalid-focus-color)}[dir=rtl] :where(input,select,textarea):not([type=checkbox],[type=radio]):is([aria-invalid],[aria-invalid=true],[aria-invalid=false]){background-position:center left .75rem}input::placeholder,input::-webkit-input-placeholder,textarea::placeholder,textarea::-webkit-input-placeholder,select:invalid{color:var(--form-element-placeholder-color);opacity:1}input:not([type=checkbox],[type=radio]),select,textarea{margin-bottom:var(--spacing)}select::-ms-expand{border:0;background-color:rgba(0,0,0,0)}select:not([multiple],[size]){padding-right:calc(var(--form-element-spacing-horizontal) + 1.5rem);padding-left:var(--form-element-spacing-horizontal);padding-inline-start:var(--form-element-spacing-horizontal);padding-inline-end:calc(var(--form-element-spacing-horizontal) + 1.5rem);background-image:var(--icon-chevron);background-position:center right .75rem;background-size:1rem auto;background-repeat:no-repeat}[dir=rtl] select:not([multiple],[size]){background-position:center left .75rem}:where(input,select,textarea,.grid)+small{display:block;width:100%;margin-top:calc(var(--spacing)*-0.75);margin-bottom:var(--spacing);color:var(--muted-color)}label>:where(input,select,textarea){margin-top:calc(var(--spacing)*.25)}[type=color]::-webkit-color-swatch-wrapper{padding:0}[type=color]::-moz-focus-inner{padding:0}[type=color]::-webkit-color-swatch{border:0;border-radius:calc(var(--border-radius)*.5)}[type=color]::-moz-color-swatch{border:0;border-radius:calc(var(--border-radius)*.5)}input:not([type=checkbox],[type=radio],[type=range],[type=file]):is([type=date],[type=datetime-local],[type=month],[type=time],[type=week]){--icon-position: 0.75rem;--icon-width: 1rem;padding-right:calc(var(--icon-width) + var(--icon-position));background-image:var(--icon-date);background-position:center right var(--icon-position);background-size:var(--icon-width) auto;background-repeat:no-repeat}input:not([type=checkbox],[type=radio],[type=range],[type=file])[type=time]{background-image:var(--icon-time)}[type=date]::-webkit-calendar-picker-indicator,[type=datetime-local]::-webkit-calendar-picker-indicator,[type=month]::-webkit-calendar-picker-indicator,[type=time]::-webkit-calendar-picker-indicator,[type=week]::-webkit-calendar-picker-indicator{width:var(--icon-width);margin-right:calc(var(--icon-width)*-1);margin-left:var(--icon-position);opacity:0}[dir=rtl] :is([type=date],[type=datetime-local],[type=month],[type=time],[type=week]){text-align:right}[type=file]{--color: var(--muted-color);padding:calc(var(--form-element-spacing-vertical)*.5) 0;border:0;border-radius:0;background:none}[type=file]::file-selector-button{--background-color: var(--secondary);--border-color: var(--secondary);--color: var(--secondary-inverse);margin-right:calc(var(--spacing)/2);margin-left:0;margin-inline-start:0;margin-inline-end:calc(var(--spacing)/2);padding:calc(var(--form-element-spacing-vertical)*.5) calc(var(--form-element-spacing-horizontal)*.5);border:var(--border-width) solid var(--border-color);border-radius:var(--border-radius);outline:none;background-color:var(--background-color);box-shadow:var(--box-shadow);color:var(--color);font-weight:var(--font-weight);font-size:1rem;line-height:var(--line-height);text-align:center;cursor:pointer;transition:background-color var(--transition),border-color var(--transition),color var(--transition),box-shadow var(--transition)}[type=file]::file-selector-button:is(:hover,:active,:focus){--background-color: var(--secondary-hover);--border-color: var(--secondary-hover)}[type=file]::-webkit-file-upload-button{--background-color: var(--secondary);--border-color: var(--secondary);--color: var(--secondary-inverse);margin-right:calc(var(--spacing)/2);margin-left:0;margin-inline-start:0;margin-inline-end:calc(var(--spacing)/2);padding:calc(var(--form-element-spacing-vertical)*.5) calc(var(--form-element-spacing-horizontal)*.5);border:var(--border-width) solid var(--border-color);border-radius:var(--border-radius);outline:none;background-color:var(--background-color);box-shadow:var(--box-shadow);color:var(--color);font-weight:var(--font-weight);font-size:1rem;line-height:var(--line-height);text-align:center;cursor:pointer;transition:background-color var(--transition),border-color var(--transition),color var(--transition),box-shadow var(--transition)}[type=file]::-webkit-file-upload-button:is(:hover,:active,:focus){--background-color: var(--secondary-hover);--border-color: var(--secondary-hover)}[type=file]::-ms-browse{--background-color: var(--secondary);--border-color: var(--secondary);--color: var(--secondary-inverse);margin-right:calc(var(--spacing)/2);margin-left:0;margin-inline-start:0;margin-inline-end:calc(var(--spacing)/2);padding:calc(var(--form-element-spacing-vertical)*.5) calc(var(--form-element-spacing-horizontal)*.5);border:var(--border-width) solid var(--border-color);border-radius:var(--border-radius);outline:none;background-color:var(--background-color);box-shadow:var(--box-shadow);color:var(--color);font-weight:var(--font-weight);font-size:1rem;line-height:var(--line-height);text-align:center;cursor:pointer;transition:background-color var(--transition),border-color var(--transition),color var(--transition),box-shadow var(--transition)}[type=file]::-ms-browse:is(:hover,:active,:focus){--background-color: var(--secondary-hover);--border-color: var(--secondary-hover)}[type=range]{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:100%;height:1.25rem;background:none}[type=range]::-webkit-slider-runnable-track{width:100%;height:.25rem;border-radius:var(--border-radius);background-color:var(--range-border-color);transition:background-color var(--transition),box-shadow var(--transition)}[type=range]::-moz-range-track{width:100%;height:.25rem;border-radius:var(--border-radius);background-color:var(--range-border-color);transition:background-color var(--transition),box-shadow var(--transition)}[type=range]::-ms-track{width:100%;height:.25rem;border-radius:var(--border-radius);background-color:var(--range-border-color);transition:background-color var(--transition),box-shadow var(--transition)}[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:1.25rem;height:1.25rem;margin-top:-0.5rem;border:2px solid var(--range-thumb-border-color);border-radius:50%;background-color:var(--range-thumb-color);cursor:pointer;transition:background-color var(--transition),transform var(--transition)}[type=range]::-moz-range-thumb{-webkit-appearance:none;width:1.25rem;height:1.25rem;margin-top:-0.5rem;border:2px solid var(--range-thumb-border-color);border-radius:50%;background-color:var(--range-thumb-color);cursor:pointer;transition:background-color var(--transition),transform var(--transition)}[type=range]::-ms-thumb{-webkit-appearance:none;width:1.25rem;height:1.25rem;margin-top:-0.5rem;border:2px solid var(--range-thumb-border-color);border-radius:50%;background-color:var(--range-thumb-color);cursor:pointer;transition:background-color var(--transition),transform var(--transition)}[type=range]:hover,[type=range]:focus{--range-border-color: var(--range-active-border-color);--range-thumb-color: var(--range-thumb-hover-color)}[type=range]:active{--range-thumb-color: var(--range-thumb-active-color)}[type=range]:active::-webkit-slider-thumb{transform:scale(1.25)}[type=range]:active::-moz-range-thumb{transform:scale(1.25)}[type=range]:active::-ms-thumb{transform:scale(1.25)}input:not([type=checkbox],[type=radio],[type=range],[type=file])[type=search]{padding-inline-start:calc(var(--form-element-spacing-horizontal) + 1.75rem);border-radius:5rem;background-image:var(--icon-search);background-position:center left 1.125rem;background-size:1rem auto;background-repeat:no-repeat}input:not([type=checkbox],[type=radio],[type=range],[type=file])[type=search][aria-invalid]{padding-inline-start:calc(var(--form-element-spacing-horizontal) + 1.75rem);background-position:center left 1.125rem,center right .75rem}input:not([type=checkbox],[type=radio],[type=range],[type=file])[type=search][aria-invalid=false]{background-image:var(--icon-search),var(--icon-valid)}input:not([type=checkbox],[type=radio],[type=range],[type=file])[type=search][aria-invalid=true]{background-image:var(--icon-search),var(--icon-invalid)}[type=search]::-webkit-search-cancel-button{-webkit-appearance:none;display:none}[dir=rtl] :where(input):not([type=checkbox],[type=radio],[type=range],[type=file])[type=search]{background-position:center right 1.125rem}[dir=rtl] :where(input):not([type=checkbox],[type=radio],[type=range],[type=file])[type=search][aria-invalid]{background-position:center right 1.125rem,center left .75rem}input:not([type=checkbox],[type=radio],[type=range],[type=file])[type=search]{background-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='rgb(65, 84, 98)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='11' cy='11' r='8'></circle><line x1='21' y1='21' x2='16.65' y2='16.65'></line></svg>")}:where(table){width:100%;border-collapse:collapse;border-spacing:0;text-indent:0}th,td{padding:calc(var(--spacing)/2) var(--spacing);border-bottom:var(--border-width) solid var(--table-border-color);color:var(--color);font-weight:var(--font-weight);font-size:var(--font-size);text-align:left;text-align:start}tfoot th,tfoot td{border-top:var(--border-width) solid var(--table-border-color);border-bottom:0}table[role=grid] tbody tr:nth-child(odd){background-color:var(--table-row-stripped-background-color)}pre,code,kbd,samp{font-size:.875em;font-family:var(--font-family)}pre{-ms-overflow-style:scrollbar;overflow:auto}pre,code,kbd{border-radius:var(--border-radius);background:var(--code-background-color);font-weight:var(--font-weight);line-height:initial}code,kbd{display:inline-block;padding:.375rem .5rem}pre{display:block;margin-bottom:var(--spacing);margin-top:var(--spacing);padding:calc(.5*var(--spacing));overflow-x:auto}pre>code{display:block;padding:var(--spacing);background:none;line-height:var(--line-height)}kbd{background-color:var(--code-kbd-background-color);color:var(--code-kbd-color);vertical-align:baseline}figure.highlight{margin:0;padding:0;border:0;font-family:inherit}.highlight{font-family:inherit}.highlight{background-color:#f8f8f8}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .c{color:#998;font-style:italic}.highlight .ch{color:#998;font-style:italic}.highlight .cd{color:#998;font-style:italic}.highlight .cpf{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .gd{color:#000;background-color:#fdd}.highlight .ge{color:#000;font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{color:#000;font-weight:bold}.highlight .kd{color:#000;font-weight:bold}.highlight .kn{color:#000;font-weight:bold}.highlight .kp{color:#000;font-weight:bold}.highlight .kr{color:#000;font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .k{color:#000;font-weight:bold}.highlight .kv{color:#000;font-weight:bold}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .il{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .m{color:#099}.highlight .mb{color:#099}.highlight .mx{color:#099}.highlight .sa{color:#000;font-weight:bold}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .s{color:#d14}.highlight .dl{color:#d14}.highlight .na{color:teal}.highlight .bp{color:#999}.highlight .nb{color:#0086b3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:teal}.highlight .nd{color:#3c5d5d;font-weight:bold}.highlight .ni{color:purple}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .fm{color:#900;font-weight:bold}.highlight .nl{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .nv{color:teal}.highlight .vm{color:teal}.highlight .ow{color:#000;font-weight:bold}.highlight .o{color:#000;font-weight:bold}.highlight .w{color:#bbb}hr{height:0;border:0;border-top:1px solid var(--muted-border-color);color:inherit}[hidden],template{display:none}canvas{display:inline-block}details{display:block;margin-bottom:var(--spacing);padding-bottom:var(--spacing);border-bottom:var(--border-width) solid var(--accordion-border-color)}details summary{line-height:1rem;list-style-type:none;cursor:pointer;transition:color var(--transition)}details summary:not([role]){color:var(--accordion-close-summary-color)}details summary::-webkit-details-marker{display:none}details summary::marker{display:none}details summary::-moz-list-bullet{list-style-type:none}details summary::after{display:block;width:1rem;height:1rem;margin-inline-start:calc(var(--spacing, 1rem)*.5);float:right;transform:rotate(-90deg);background-image:var(--icon-chevron);background-position:right center;background-size:1rem auto;background-repeat:no-repeat;content:"";transition:transform var(--transition)}details summary:focus{outline:none}details summary:focus:not([role=button]){color:var(--accordion-active-summary-color)}details summary[role=button]{width:100%;text-align:left}details summary[role=button]::after{height:calc(1rem*var(--line-height, 1.5));background-image:var(--icon-chevron-button)}details summary[role=button]:not(.outline).contrast::after{background-image:var(--icon-chevron-button-inverse)}details[open]>summary{margin-bottom:calc(var(--spacing))}details[open]>summary:not([role]):not(:focus){color:var(--accordion-open-summary-color)}details[open]>summary::after{transform:rotate(0)}[dir=rtl] details summary{text-align:right}[dir=rtl] details summary::after{float:left;background-position:left center}:where(nav li)::before{float:left;content:"​"}nav,nav ul{display:flex}nav{justify-content:space-between}nav ol,nav ul{align-items:center;margin-bottom:0;padding:0;list-style:none}nav ol:first-of-type,nav ul:first-of-type{margin-left:calc(var(--nav-element-spacing-horizontal)*-1)}nav ol:last-of-type,nav ul:last-of-type{margin-right:calc(var(--nav-element-spacing-horizontal)*-1)}nav li{display:inline-block;margin:0;padding:var(--nav-element-spacing-vertical) var(--nav-element-spacing-horizontal)}nav li>*{--spacing: 0}nav :where(a,[role=link]){display:inline-block;margin:calc(var(--nav-link-spacing-vertical)*-1) calc(var(--nav-link-spacing-horizontal)*-1);padding:var(--nav-link-spacing-vertical) var(--nav-link-spacing-horizontal);border-radius:var(--border-radius);text-decoration:none}nav :where(a,[role=link]):is([aria-current],:hover,:active,:focus){text-decoration:none}nav[aria-label=breadcrumb]{align-items:center;justify-content:start}nav[aria-label=breadcrumb] ul li:not(:first-child){margin-inline-start:var(--nav-link-spacing-horizontal)}nav[aria-label=breadcrumb] ul li:not(:last-child) ::after{position:absolute;width:calc(var(--nav-link-spacing-horizontal)*2);margin-inline-start:calc(var(--nav-link-spacing-horizontal)/2);content:"/";color:var(--muted-color);text-align:center}nav[aria-label=breadcrumb] a[aria-current]{background-color:rgba(0,0,0,0);color:inherit;text-decoration:none;pointer-events:none}nav [role=button]{margin-right:inherit;margin-left:inherit;padding:var(--nav-link-spacing-vertical) var(--nav-link-spacing-horizontal)}aside nav,aside ol,aside ul,aside li{display:block}aside li{padding:calc(var(--nav-element-spacing-vertical)*.5) var(--nav-element-spacing-horizontal)}aside li a{display:block}aside li [role=button]{margin:inherit}[dir=rtl] nav[aria-label=breadcrumb] ul li:not(:last-child) ::after{content:"\\"}nav input:not([type=checkbox],[type=radio]),nav select,nav textarea{width:100%;max-width:300px}nav[aria-label=breadcrumb] ul li:not(:last-child) ::after{text-decoration:none}details[role=list],li[role=list]{position:relative}details[role=list] summary+ul,li[role=list]>ul{display:flex;z-index:99;position:absolute;top:auto;right:0;left:0;flex-direction:column;margin:0;padding:0;border:var(--border-width) solid var(--dropdown-border-color);border-radius:var(--border-radius);border-top-right-radius:0;border-top-left-radius:0;background-color:var(--dropdown-background-color);box-shadow:var(--card-box-shadow);color:var(--dropdown-color);white-space:nowrap}details[role=list] summary+ul li,li[role=list]>ul li{width:100%;margin-bottom:0;padding:calc(var(--form-element-spacing-vertical)*.5) var(--form-element-spacing-horizontal);list-style:none}details[role=list] summary+ul li:first-of-type,li[role=list]>ul li:first-of-type{margin-top:calc(var(--form-element-spacing-vertical)*.5)}details[role=list] summary+ul li:last-of-type,li[role=list]>ul li:last-of-type{margin-bottom:calc(var(--form-element-spacing-vertical)*.5)}details[role=list] summary+ul li a,li[role=list]>ul li a{display:block;margin:calc(var(--form-element-spacing-vertical)*-0.5) calc(var(--form-element-spacing-horizontal)*-1);padding:calc(var(--form-element-spacing-vertical)*.5) var(--form-element-spacing-horizontal);overflow:hidden;color:var(--dropdown-color);text-decoration:none;text-overflow:ellipsis}details[role=list] summary+ul li a:hover,li[role=list]>ul li a:hover{background-color:var(--dropdown-hover-background-color)}details[role=list] summary::after,li[role=list]>a::after{display:block;width:1rem;height:calc(1rem*var(--line-height, 1.5));margin-inline-start:.5rem;float:right;transform:rotate(0deg);background-position:right center;background-size:1rem auto;background-repeat:no-repeat;content:""}details[role=list]{padding:0;border-bottom:none}details[role=list] summary{margin-bottom:0}details[role=list] summary:not([role]){height:calc(1rem*var(--line-height) + var(--form-element-spacing-vertical)*2 + var(--border-width)*2);padding:var(--form-element-spacing-vertical) var(--form-element-spacing-horizontal);border:var(--border-width) solid var(--form-element-border-color);border-radius:var(--border-radius);background-color:var(--form-element-background-color);color:var(--form-element-placeholder-color);line-height:inherit;cursor:pointer;transition:background-color var(--transition),border-color var(--transition),color var(--transition),box-shadow var(--transition)}details[role=list] summary:not([role]):active,details[role=list] summary:not([role]):focus{border-color:var(--form-element-active-border-color);background-color:var(--form-element-active-background-color)}details[role=list] summary:not([role]):focus{box-shadow:0 0 0 var(--outline-width) var(--form-element-focus-color)}details[role=list][open] summary{border-bottom-right-radius:0;border-bottom-left-radius:0}details[role=list][open] summary::before{display:block;z-index:1;position:fixed;top:0;right:0;bottom:0;left:0;background:none;content:"";cursor:default}nav details[role=list] summary,nav li[role=list] a{display:flex;direction:ltr}nav details[role=list] summary+ul,nav li[role=list]>ul{min-width:fit-content;border-radius:var(--border-radius)}nav details[role=list] summary+ul li a,nav li[role=list]>ul li a{border-radius:0}nav details[role=list] summary,nav details[role=list] summary:not([role]){height:auto;padding:var(--nav-link-spacing-vertical) var(--nav-link-spacing-horizontal)}nav details[role=list][open] summary{border-radius:var(--border-radius)}nav details[role=list] summary+ul{margin-top:var(--outline-width);margin-inline-start:0}nav details[role=list] summary[role=link]{margin-bottom:calc(var(--nav-link-spacing-vertical)*-1);line-height:var(--line-height)}nav details[role=list] summary[role=link]+ul{margin-top:calc(var(--nav-link-spacing-vertical) + var(--outline-width));margin-inline-start:calc(var(--nav-link-spacing-horizontal)*-1)}li[role=list]:hover>ul,li[role=list] a:active~ul,li[role=list] a:focus~ul{display:flex}li[role=list]>ul{display:none;margin-top:calc(var(--nav-link-spacing-vertical) + var(--outline-width));margin-inline-start:calc(var(--nav-element-spacing-horizontal) - var(--nav-link-spacing-horizontal))}li[role=list]>a::after{background-image:var(--icon-chevron)}summary[role=link]{transition:color var(--transition)}summary[role=link]::-webkit-details-marker{display:none}summary[role=link]::marker{display:none}summary[role=link]::-moz-list-bullet{list-style-type:none}summary[role=link]::after{display:block;width:1rem;height:1rem;margin-inline-start:calc(var(--spacing, 1rem)*.5);float:right;transform:rotate(-90deg);background-image:url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='rgb(65, 84, 98)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>");background-position:right center;background-size:1rem auto;background-repeat:no-repeat;content:"";transition:transform var(--transition)}[aria-controls]{cursor:pointer}[aria-disabled=true],[disabled]{cursor:not-allowed}[aria-hidden=false][hidden]{display:initial}[aria-hidden=false][hidden]:not(:focus){clip:rect(0, 0, 0, 0);position:absolute}a,area,button,input,label,select,summary,textarea,[tabindex]{-ms-touch-action:manipulation}[dir=rtl]{direction:rtl}@font-face{font-family:"Comic Neue";font-style:normal;font-weight:400;font-display:swap;src:local("Comic Neue"),local("Comic Neue"),url("/assets/fonts/ComicNeueSubset.woff2") format("woff2")}@font-face{font-family:"AoyagiKouzanTSubset";font-style:normal;font-weight:400;font-display:swap;src:local("AoyagiKouzanTSubset"),local("AoyagiKouzanTSubset"),url("/assets/fonts/AoyagiKouzanTSubset.woff2") format("woff2")}.title-font{font-family:"Comic Neue","AoyagiKouzanTSubset",sans-serif}#top{border-radius:80%}.wrapper{min-height:100%}header{position:sticky;top:0;background-color:var(--background-color);box-shadow:0 6px 10px -10px rgba(0,0,0,.7);margin-bottom:var(--spacing);z-index:100}header nav{--nav-element-spacing-vertical: 0.25rem;--form-element-spacing-vertical: 0.25rem;--typography-spacing-vertical: 0rem}.langselector{margin-left:auto}#table-of-contents{align-items:center;justify-content:start;border-bottom:1px solid rgba(0,0,0,.1);margin-bottom:10px;padding-bottom:10px}#table-of-contents h2{--font-size: 1rem;border:none}#table-of-contents h2:after{content:":";padding:0;margin:0;margin-right:var(--nav-link-spacing-horizontal)}#table-of-contents ul li:not(:first-child){margin-inline-start:var(--nav-link-spacing-horizontal)}#table-of-contents ul li:not(:last-child) ::after{position:absolute;width:calc(var(--nav-link-spacing-horizontal)*2);margin-inline-start:calc(var(--nav-link-spacing-horizontal)/2);content:"/";color:var(--muted-color);text-align:center;text-decoration:none}#table-of-contents a[aria-current]{background-color:rgba(0,0,0,0);color:inherit;text-decoration:none;pointer-events:none}footer p{text-align:right}.profile-picture{height:20vw;max-height:260px;width:20vw;max-width:260px;position:relative;float:right;border-radius:50%;margin-top:-1rem}.menu-btn{display:none}@media(min-width: 768px){.md-hide{display:none}.back_to_top{margin-left:85%}.title-font{font-size:3rem}}@media(max-width: 768px){.menu-icon{display:flex;height:60px;width:60px;justify-content:center;align-items:center;position:relative;z-index:200;cursor:pointer}.menu-icon span,.menu-icon span:before,.menu-icon span:after{content:"";display:block;height:3px;width:25px;border-radius:3px;background:#000;transition:.5s;position:absolute}.menu-icon span:before{bottom:8px}.menu-icon span:after{top:8px}#menu-btn:checked~.menu-icon span{background:#fff}#menu-btn:checked~.menu-icon span::before{bottom:0;transform:rotate(45deg)}#menu-btn:checked~.menu-icon span::after{top:0;transform:rotate(-45deg)}.menu{width:100%;height:100%;position:fixed;top:0;left:100%;z-index:200;background:#fff;transition:.5s;flex-direction:column;margin-top:120px}#menu-btn:checked~.menu{left:0;width:100%}.title-font{font-size:2rem}#table-of-contents{display:none}.sm-hide{display:none}.profile-picture{margin-top:-4rem}}.logo{border-radius:80%}.icon-envelope svg,.icon-key svg,.icon-keybase svg,.icon-twitter svg,.icon-facebook svg,.icon-github svg,.icon-mastodon svg,.icon-amp svg{height:1.2rem;width:1.2rem}.icon-envelope{color:#242424}.icon-key{color:#ff8c00}.icon-keybase{color:#ff8c00}.icon-twitter{color:#55acee}.icon-facebook{color:#3b5998}.icon-github{color:#4c4c4c}.icon-mastodon{color:#3b5998}.icon-amp{color:#ff851b}.research li:nth-child(even){background-color:#f5f5f5}.back_to_top{position:sticky;bottom:20px;margin-top:100vh;margin-left:calc(100% - 20px - 6rem);text-decoration:none;padding:10px;color:#fff;background:#000;border-radius:100px;white-space:nowrap}.nowrap{white-space:pre}a:hover{text-decoration:underline}span.anchor{display:none}.sanchor{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAAAAAA6I3INAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAAAOAAAADgCxW/H3AAAAH0lEQVQI12M4jAIYDv9HAni4hw/Tmgt3E1YuiqtQAAD5Nq+Ne1ON1gAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxMi0wNy0zMVQxNTowNDowNCswOTowMONpTpcAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMDctMTAtMjhUMDc6NDY6MzArMDk6MDAE9UrdAAAAAElFTkSuQmCC);background-position:bottom right;background-repeat:no-repeat;padding:14px 14px 0px 0px;color:#fff;background-color:rgba(0,0,0,0);font-size:1px}.canchor{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAAAMAAAADADOpTJ+AAAAIElEQVQI12P4jwQYsHKOHDlCDAe3AVAOSDVcD24OAgAAVIGJOMkyXx4AAAAldEVYdGRhdGU6Y3JlYXRlADIwMTItMDctMzFUMTU6MDM6NTgrMDk6MDCO9TH+AAAAJXRFWHRkYXRlOm1vZGlmeQAyMDA3LTEwLTI4VDA3OjQ2OjMwKzA5OjAwBPVK3QAAAABJRU5ErkJggg==);background-position:bottom right;background-repeat:no-repeat;padding:12px 12px 0px 0px;color:#fff;background-color:rgba(0,0,0,0);font-size:1px}.mail{display:none}.sanchor:before{display:block;content:" ";margin-top:-110px;height:110px;visibility:hidden}p.source{text-align:right;font-size:80%}p.source cite{font-style:normal}.day h2{font-size:1rem}.amp-htb{--nav-link-spacing-vertical: 0;--nav-link-spacing-horizontal: 0}.comment{display:none}.tdiary-profile-picture{border-radius:50%;width:30vw;max-width:260px;max-height:260px;margin-left:auto;margin-right:auto}@media(max-width: 768px){.tdiary-profile-picture{display:none}}.footer{display:block;margin:0 auto;text-align:right;width:100%}*[id]:before{display:block;content:" ";margin-top:-120px;height:120px;visibility:hidden}    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <meta name="author" content="Youhei SASAKI">
    <!-- end: check google site verification -->
    <!-- alternate -->
    <link rel="alternate" hreflang="ja" href="https://uwabami.github.io/cc-env/DebianMail.html" />
    <!-- end: alternate -->
    <!-- begin jekyll seo -->
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mail 環境の設定 | Youhei SASAKI’s official site</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Mail 環境の設定" />
<meta name="author" content="Youhei SASAKI" />
<meta property="og:locale" content="ja" />
<link rel="canonical" href="https://uwabami.github.io/cc-env/DebianMail.html" />
<meta property="og:url" content="https://uwabami.github.io/cc-env/DebianMail.html" />
<meta property="og:site_name" content="Youhei SASAKI’s official site" />
<meta property="og:image" content="https://uwabami.github.io/assets/img/eyecatch_1600x900.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-14T06:59:54+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://uwabami.github.io/assets/img/eyecatch_1600x900.png" />
<meta property="twitter:title" content="Mail 環境の設定" />
<meta name="twitter:site" content="@uwabami" />
<meta name="twitter:creator" content="@Youhei SASAKI" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Youhei SASAKI","url":"https://uwabami.github.io/"},"dateModified":"2021-08-14T06:59:54+09:00","datePublished":"2021-08-14T06:59:54+09:00","headline":"Mail 環境の設定","image":"https://uwabami.github.io/assets/img/eyecatch_1600x900.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://uwabami.github.io/cc-env/DebianMail.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://uwabami.github.io/assets/img/eyecatch_1600x900.png"},"name":"Youhei SASAKI"},"url":"https://uwabami.github.io/cc-env/DebianMail.html"}</script>
<!-- End Jekyll SEO tag -->
    <!-- end jekyll seo -->
    <link rel="icon" type="image/x-icon" href="https://uwabami.github.io/assets/img/favicon.ico">
    <!-- apple icons -->
    <link rel="apple-touch-icon" href="https://uwabami.github.io/assets/img/favicon-256x256.png">
    <link rel="shortcut-icon" type="image/ico" href="/assets/img/favicon.ico">
  </head>
  <body>
    <!-- include: gdpr -->
<amp-geo layout="nodisplay">
  <script type="application/json">
    {
        "ISOCountryGroups": {
            "eu": [ "preset-eea"]
        }
    }
  </script>
</amp-geo>
<amp-consent layout="nodisplay" id="consent-element">
  <script type="application/json">
    {
        "consents": {
            "my_consent": {
                "promptIfUnknownForGeoGroup": "eu",
                "promptUI": "consent-ui"
            }
        }
    }
  </script>
  <div id="consent-ui">
    <p>I use cookies to analyze how visitors use my website via Google Analytics:</p>
    <button on="tap:consent-element.accept" role="button">Accept</button>
    <button on="tap:consent-element.reject" role="button">Reject</button>
    <button on="tap:consent-element.dismiss" role="button">Dismiss</button>
  </div>
</amp-consent>
    <!-- end include: gdpr -->
    <div class="wrapper container">
      <header>
        <!-- page loop -->
<nav>
  <ul>
    <li>
      <a href="/index.html">
        <amp-img layout="fixed"
                 width="1.2rem"
                 height="1.2rem"
                 src="/assets/img/top.webp"
                 alt="About"
                 id="top">
          <amp-img fallback
                   layout="fixed"
                   width="1.2rem"
                   height="1.2rem"
                   src="/assets/img/top.jpg"
                   alt="About"
                   id="top">
          </amp-img>
        </amp-img>
      </a>
    </li>
  </ul>
  <input class="menu-btn" type="checkbox" id="menu-btn"/>
  <label class="menu-icon" for="menu-btn"><span></span></label>
  <ul class="menu">
    <!-- lang ja -->
    <li>
      <a href="/research/index.html">
        Research
      </a>
    </li>
    <li>
      <details role="list">
        <summary aria-haspopup="listbox" role="link">Software</summary>
        <ul>
          <li>
            <a href="/software/index.html">
              Repository
            </a>
          </li>
          <li>
            <a href="/cc-env/index.html">
              Comp. Memo
            </a>
          </li>
        </ul>
      </details>
    </li>
    <li>
      <a href="https://uwabami.junkhub.org/log">blog</a>
    </li>
    <li>
      <form method="GET"
            action="https://www.google.com/cse"
            target="_top">
        <input name="cx" type="hidden"
               value="017455171263919107349:oumnpe4bynr" />
        <input name="ie" type="hidden" value="UTF-8" />
        <input type="search" placeholder="検索" name="q" required>
      </form>
    </li>
    
  </ul>
</nav>

        <nav aria-label="breadcrumb">
  <ul>
    <!-- create crumbs -->
    <li>
      <a href="/index.html">
        Top
      </a>
    </li>
    <li><a href="/cc-env/index.html">Cc-env</a></li>      <!-- end page loop -->
  </ul>
  <span class="langselector"><!-- end: lang selector -->
  </span>
</nav>

      </header>
      <main role="main">
        <div class="content">
          <h1 class="page-title">Mail 環境の設定</h1>
          <hr>
<nav id="table-of-contents">
<h2>目次</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org02aae9c7">始めに</a></li>
<li><a href="#orgc6ac0121">送信設定: Exim4</a></li>
<li><a href="#org5afde083">送信設定: msmtp</a></li>
<li><a href="#orgbf2f5d08">受信</a></li>
</ul>
</div>
</nav>
<p>
Related <a href="https://uwabami.github.io/cc-env/index.html">Index</a> <a href="index.html#orge0707863">Debian</a>
</p>
<div>
<h2 id="org02aae9c7">始めに</h2>
<div class="outline-text-2" id="text-org02aae9c7">
<p>
メールに関するアレコレ.
ネットワーク接続を意識したくないので,
送受信用のサーバを手元に置いて MUA はなるべくここを叩くようにしている.
</p>
</div>
</div>
<div>
<h2 id="orgc6ac0121">送信設定: Exim4</h2>
<div class="outline-text-2" id="text-orgc6ac0121">
<p>
smarthost での送信だけなら Exim4 が軽量で楽。
他にも幾つか選択肢はある。気になるなら <a href="https://wiki.debian.org/Debate/DefaultMTA">Debian Wiki: DefaultMTA</a> あたり参照のこと。
欲しい機能は
</p>
<ul class="org-ul">
<li>上流の MTA への smarthost 送信。</li>
<li>offline 時の queue</li>
<li>localhost:25 での待受</li>
</ul>
<p>
なので、軽いしとりあえず Exim4 をそのまま使っている。
</p>
<pre class="example">
$ sudo -s
# dpkg-reconfigure -plow exim4-config
  メール設定の一般的なタイプ: 2. スマートホストでメール送信; SMTP または fetchmail で受信する
  システムメール名: localhost
  入力側 SMTP 接続をリスンする IP アドレス: 127.0.0.1
  メールを受け取るその他の宛先: [空白]
  メールをリレーするマシン: [空白]
  送出スマートホストの IP アドレスまたはホスト名: スマートホスト用の送信サーバ::587
  送出するメールでローカルメール名を隠しますか? no
  DNS クエリの数を最小限に留めますか (ダイヤルオンデマンド)? no
  ローカルメールの配送方式: 1. /var/mail/ 内の mbox 形式
  設定を小さなファイルに分割しますか?: no
  root と postmaster のメール受信者: 適当に設定
</pre>
<p>
そのあと, <code>/etc/exim4/passwd.client</code> 内で, スマートホストの設定
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">スマートホスト送信サーバ:[アカウント]:[パスワード]</code></pre></figure>
<p>
そして必要なら <code>/etc/exim4/email-addresses</code> に置換するリストを適当に記述.
最低限 root と ユーザ宛(uid=1000) のメール送信先は設定しておく.
</p>
<pre class="example">
$ sudo -s
# upate-exim4.conf
# sudo /etc/init.d/exim4 restart
</pre>
<p>
あとは適当にテストとかしてみると良い.
</p>

<p>
(2020/04/27) このままだと message-id が "乱数列@hostname" になるので
<code>/etc/exim4/exim4.conf.localmacros</code> に
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">message_id_header_domain</span> = ドメイン名
<span class="n">message_id_header_text</span>   = ホスト名</code></pre></figure>
<p>
を追加して <code>update-exim4.conf</code> を走らせておく.
</p>

<p>
ローカル配送先を適宜設定したい場合には
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">MAILDIR_HOME_MAILDIR_LOCATION</span> = $<span class="n">home</span>/<span class="n">Maildir</span>/<span class="n">INBOX</span></code></pre></figure>
<p>
などとしておく.
</p>
</div>
</div>
<div>
<h2 id="org5afde083">送信設定: msmtp</h2>
<div class="outline-text-2" id="text-org5afde083">
<p>
<a href="/cc-env/Emacs.html#org2c2abb9b">Wanderlust</a> からメールを送る時には,
<code>msmtp</code> を使っている.
</p>

<p>
sendmail コマンド互換かつ enverope-from に応じて送信に利用する
SMTP サーバを切り替えられる, というのが良い.
本当は Gmail に SMTP サーバを登録しておいて, exim4 の smarthost で
Gmail に丸投げしたかったのだけれど,
Gmail のメールサーバは <code>Reply-To</code> を上書きしたりして行儀が良くない.
</p>

<p>
msmtp 自体の設定はいたって普通だが, queue が面倒?
結局 Emacs からは <code>sendmail</code> として
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="nv">ARGS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span>
msmtp-enqueue.sh <span class="nv">$ARGS</span> 1&gt;/dev/null
<span class="k">if</span> <span class="o">[</span> x<span class="s2">"</span><span class="si">$(</span><span class="nv">LANG</span><span class="o">=</span>C nmcli n connectivity<span class="si">)</span><span class="s2">"</span> <span class="o">=</span> x<span class="s2">"full"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>msmtp-runqueue.sh 2&gt;&amp;1 1&gt;/dev/null
<span class="k">fi
</span><span class="nb">exit </span>0</code></pre></figure>
<p>
を叩くことで, ネットワーク接続がある場合には即座に送信,
無い場合には queuing, という風に動作を切り替えている.
</p>

<p>
あとは NetworkManager の dispatcher として msmtp-runqueue を走らせれば良い.
</p>
</div>
</div>
<div>
<h2 id="orgbf2f5d08">受信</h2>
<div class="outline-text-2" id="text-orgbf2f5d08">
<p>
受信/閲覧は
</p>
<ul class="org-ul">
<li>
<a href="http://isync.sourceforge.net/">isync</a> で、リモートの IMAP サーバのメールをローカルに Maildir 形式で保存</li>
<li>ローカルで dovecot-imapd を起動してメールを閲覧</li>
</ul>
<p>
としている.
</p>

<p>
最近の MUA は多かれ少なかれ IMAP 接続でも手元にメールを持ってくるので,
このメールの重複をなんとかしたいのだけれども,
例えば Wanderlust なんかで Maildir を直接見にいくと Emacs の反応があまり芳しくない.
</p>

<p>
以前 <a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0247">第247回 Offlineimap＋Dovecotによる快適メール環境：Ubuntu Weekly Recipe</a> なんて記事を書いた。
その時は offlineimap を使っていたのだけれども
</p>
<ul class="org-ul">
<li>遅い。特に 2014 年あたりから Gmail の同期が体感できるレベルで遅くなった</li>
<li>偶に block するし、imap の接続数が酷い事になる。</li>
</ul>
<p>
ということで、2015 年から <a href="http://isync.sourceforge.net/">isync: free IMAP and MailDir mailbox synchronizer</a> に移行した。
</p>
</div>
<div>
<h3 id="org1b669e8c">
<span class="todo TODO">TODO</span> mbsync/isync</h3>
<div class="outline-text-3" id="text-org1b669e8c">
<p>
isync/mbsync はリモートの IMAP サーバとローカルの Maildir を同期するソフトウェア。
gmail の <code>XOAUTH2</code> に対応するために <a href="https://salsa.debian.org/uwabami/libsasl2-module-xoauth2">libsasl2-module-xoauth2</a> なんてものを
パッケージ化していたりする. ←あとで書く.
</p>
</div>
<div>
<h4 id="org14da667f">インストール: mbsync/isync</h4>
<div class="outline-text-4" id="text-org14da667f">
<p>
実行バイナリは <code>isync</code> もしくは <code>mbsync</code> 。以前の名前が <code>isync</code> なので、Debian のパッケージ名はそのままである。
</p>
<pre class="example">
$ sudo apt-get install isync
</pre>
<p>
apt 万歳
</p>
</div>
</div>
<div>
<h4 id="org2ddeb5a8">設定: mbsync/isync</h4>
<div class="outline-text-4" id="text-org2ddeb5a8">
<p>
設定ファイルは <code>~/.mbsyncrc</code>.
設定例は以下:
</p>
<ul class="org-ul">
<li>
<code>~/Maildir/</code> 以下にサーバのメールを同期する</li>
<li>
<code>~/Maildir/INBOX.mobile.XXX</code> に imap.mobile.com のメールを同期.
<ul class="org-ul">
<li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
</ul>
</li>
<li>
<code>~/Maildir/INBOX.Gmail.XXX</code> に Gmail のメールを同期
<ul class="org-ul">
<li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
<li>
<code>[Gmail]/</code> というラベルを上手く扱えないので、同期チャンネルを複数設定することで対応
<ul class="org-ul">
<li>今のところ SPAM 堕ちしたメールの確認のためだけに <code>~/Maildir/INBOX.Gmail.Junk</code> のみ確認している</li>
</ul>
</li>
</ul>
</li>
<li>
<code>~/Maildir/INBOX</code> に <code>work.example.com</code> のメールを同期
<ul class="org-ul">
<li>
<code>work.example.com</code> メールサーバのディレクトリが <code>work/2014</code> 等と "/" 区切りになっているので <code>Flatten: .</code> で
<code>INBOX.work.2014</code> 等に変換する。そのために <code>MaildirStore</code> を複数設定している</li>
<li>
<code>Pattern: * !*mobile* !*Gmail*</code> で同期から除外する <code>Maildir</code> を指定する</li>
</ul>
</li>
<li>PassCmd で gpg 暗号化した netrc 形式のファイルからパスワードを取得している.
<ul class="org-ul">
<li>これ、User なんかにも使えないかなぁ、とか思ったり</li>
</ul>
</li>
</ul>
<p>
今のところ特に使用に際して困った事はおきていない。
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">IMAPAccount</span> <span class="n">mobile</span>
<span class="n">Host</span> <span class="n">mobile</span>.<span class="n">example</span>.<span class="n">com</span>
<span class="n">User</span> <span class="n">TheMobileUserAccount</span>
<span class="n">PassCmd</span> <span class="s2">"echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine mobile.example.com .*password \\\([^ ]*\\) port.*,\\1,p')}"</span>
<span class="n">Port</span> <span class="m">993</span>
<span class="n">UseIMAPS</span> <span class="n">yes</span>
<span class="n">RequireSSL</span> <span class="n">yes</span>
<span class="n">UseTLSv1</span>.<span class="m">2</span> <span class="n">yes</span>
<span class="n">CertificateFile</span> /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="n">IMAPAccount</span> <span class="n">work</span>
<span class="n">Host</span> <span class="n">work</span>.<span class="n">example</span>.<span class="n">com</span>
<span class="n">User</span> <span class="n">TheWorkUserAccount</span>
<span class="n">PassCmd</span> <span class="s2">"echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine work.example.com .*password \\\([^ ]*\\) port.*,\\1,p')}"</span>
<span class="n">Port</span> <span class="m">993</span>
<span class="n">UseIMAPS</span> <span class="n">yes</span>
<span class="n">RequireSSL</span> <span class="n">yes</span>
<span class="n">UseTLSv1</span>.<span class="m">2</span> <span class="n">yes</span>
<span class="n">CertificateFile</span> /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="n">IMAPAccount</span> <span class="n">gmail</span>
<span class="n">Host</span> <span class="n">imap</span>.<span class="n">gmail</span>.<span class="n">com</span>
<span class="n">User</span> <span class="n">GmailMailAddress</span>
<span class="n">PassCmd</span> <span class="s2">"echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine imap.gmail.com .*password \\\([^ ]*\\) port.*,\\1,p')}"</span>
<span class="n">Port</span> <span class="m">993</span>
<span class="n">UseIMAPS</span> <span class="n">yes</span>
<span class="n">RequireSSL</span> <span class="n">yes</span>
<span class="n">UseTLSv1</span>.<span class="m">2</span> <span class="n">yes</span>
<span class="n">CertificateFile</span> /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="n">IMAPStore</span> <span class="n">work</span>-<span class="n">remote</span>
<span class="n">Account</span> <span class="n">work</span>
<span class="n">UseNamespace</span> <span class="n">no</span>

<span class="n">IMAPStore</span> <span class="n">work</span>-<span class="n">remote</span>
<span class="n">Account</span> <span class="n">work</span>

<span class="n">IMAPStore</span> <span class="n">gmail</span>-<span class="n">remote</span>
<span class="n">Account</span> <span class="n">gmail</span>
<span class="n">UseNamespace</span> <span class="n">yes</span>

<span class="n">MaildirStore</span> <span class="n">local</span>
<span class="n">Path</span> ~/<span class="n">Maildir</span>/
<span class="n">Inbox</span> ~/<span class="n">Maildir</span>/<span class="n">INBOX</span>

<span class="n">MaildirStore</span> <span class="n">work</span>-<span class="n">local</span>
<span class="n">Path</span> ~/<span class="n">Maildir</span>/
<span class="n">Inbox</span> ~/<span class="n">Maildir</span>/<span class="n">INBOX</span>
<span class="n">Flatten</span> .

<span class="n">Channel</span> <span class="n">mobile</span>
<span class="n">Master</span> :<span class="n">mobile</span>-<span class="n">remote</span>:
<span class="n">Slave</span> :<span class="n">local</span>:<span class="n">INBOX</span>.<span class="n">mobile</span>.
<span class="n">Patterns</span> <span class="n">INBOX</span> <span class="n">Junk</span> <span class="n">Archives</span> <span class="n">Sent</span> <span class="n">Drafts</span> <span class="n">Trash</span>
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *

<span class="n">Channel</span> <span class="n">gmail</span>
<span class="n">Master</span> :<span class="n">gmail</span>-<span class="n">remote</span>:
<span class="n">Slave</span> :<span class="n">local</span>:<span class="n">INBOX</span>.<span class="n">Gmail</span>.
<span class="n">Patterns</span> <span class="n">INBOX</span>
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *

<span class="n">Channel</span> <span class="n">gmail</span>-<span class="n">junk</span>
<span class="n">Master</span> <span class="s2">":gmail-remote:[Gmail]/&amp;j,dg0TDhMPww6w-"</span>
<span class="n">Slave</span> :<span class="n">local</span>:<span class="n">INBOX</span>.<span class="n">Gmail</span>.<span class="n">Junk</span>
<span class="n">Patterns</span> *
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *

<span class="n">Channel</span> <span class="n">work</span>
<span class="n">Master</span> :<span class="n">work</span>-<span class="n">remote</span>:
<span class="n">Slave</span> :<span class="n">work</span>-<span class="n">local</span>:
<span class="n">Patterns</span> * !*<span class="n">mobile</span>* !*<span class="n">Gmail</span>*
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *</code></pre></figure>
<p>
上手く設定できているなら
</p>
<pre class="example">
mbsync -l mobile
</pre>
<p>
などとして、同期する <code>Maildir</code> を確認すると良い。
リモートとローカルでどういうマッピングがされているかわかるだろう。
25万通(6.5G)の同期にだいたい 3 時間ぐらい。
回線速度に依存するだろうけれど、offlineimap より目に見えて速い(気がする)。
また、IMAP Pipeline で処理されているので、サーバ上の IMAP connection の数は 1 つのみだった。
</p>
</div>
</div>
<div>
<h4 id="orgf55f00fe">cron での動作: mbsync/isync</h4>
<div class="outline-text-4" id="text-orgf55f00fe">
<p>
認証に GPG を使っており、認証に Gnome Keyring を用いているので
必要な環境変数を読み込んでから実行するようにする.
先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意:
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>
<span class="nb">sleep </span>5
<span class="c"># Export the dbus session address on startup so it can be used by cron</span>
<span class="nb">touch</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">chmod </span>600 <span class="nv">$HOME</span>/.Xdbus
<span class="nb">env</span> | <span class="nb">grep </span>DBUS_SESSION_BUS_ADDRESS <span class="o">&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">env</span> | <span class="nb">grep </span>GPG_AGENT_INFO <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">'export DBUS_SESSION_BUS_ADDRESS'</span> <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">'export GPG_AGENT_INFO'</span> <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus</code></pre></figure>
<p>
<code>~/.config/autostart</code> 以下に適当な名前で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">[<span class="n">Desktop</span> <span class="n">Entry</span>]
<span class="n">Type</span>=<span class="n">Application</span>
<span class="n">Exec</span>=/<span class="n">home</span>/<span class="n">uwabami</span>/.<span class="n">mua</span>/<span class="n">export_x_info</span>.<span class="n">sh</span>
<span class="n">Hidden</span>=<span class="n">false</span>
<span class="n">NoDisplay</span>=<span class="n">false</span>
<span class="n">X</span>-<span class="n">GNOME</span>-<span class="n">Autostart</span>-<span class="n">enabled</span>=<span class="n">true</span>
<span class="n">Name</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
<span class="n">Comment</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span></code></pre></figure>
<p>
を用意しておく.
</p>

<p>
あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
必要に応じて GnomeKeyring による認証が行なわれる.
cron で実行されるスクリプトは, 例えば
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="c"># -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-</span>
<span class="c">################################################################################</span>
<span class="c"># for personal settings</span>
<span class="nv">PID</span><span class="o">=</span>~/Maildir/mbsync.pid
<span class="nv">CONF</span><span class="o">=</span>~/.mbsyncrc
<span class="c"># for gnome-keyring:</span>
<span class="nb">.</span> <span class="k">${</span><span class="nv">HOME</span><span class="k">}</span>/.Xdbus
<span class="c"># check network is avaliable</span>
nm-online <span class="nt">-x</span>  2&gt;/dev/null <span class="o">||</span> <span class="nb">exit </span>0
<span class="c"># check another offlineimap</span>
timelimit <span class="nt">-T</span> 300 <span class="nt">-t</span> 300 mbsync <span class="nt">-c</span> <span class="nv">$CONF</span> <span class="nt">-a</span> 2&gt;&amp;1 <span class="o">||</span> <span class="nb">exit </span>0</code></pre></figure>
<p>
とか。mbsync 自体の timeout や PID  管理ができないので、 <code>timelinit</code> コマンドで処理をするようにしている。
実際は、二回目以降の同期は(回線速度に依存するだろうけれど) 20 秒ぐらい。
</p>
</div>
</div>
</div>
<div>
<h3 id="org4a294ad8">dovecot</h3>
<div class="outline-text-3" id="text-org4a294ad8">
</div>
<div>
<h4 id="orge30e9132">インストール: dovecot</h4>
<div class="outline-text-4" id="text-orge30e9132">
<p>
最低限 IMAP での接続ができれば良いので
</p>
<pre class="example">
% sudo apt-get install dovecot-imapd
</pre>
<p>
apt 万歳
</p>
</div>
</div>
<div>
<h4 id="org003785b7">設定: dovecot</h4>
<div class="outline-text-4" id="text-org003785b7">
<p>
最低限の設定として、
</p>
<ul class="org-ul">
<li>localhost で起動. 認証は PAM に任せる(login パスワードと同じ)</li>
<li>Maildir 形式で mbsync(もしくは offlineimap)で同期したMaildirを読む.</li>
<li>IMAP もしくは IMAP over SSL のみ</li>
</ul>
<p>
ための設定を行なう
</p>

<p>
以下、設定ファイル中のコメント行を除いた部分だけを記載しているので注意
(コメント消すなんてとんでもない!)。
</p>

<p>
先ず待受サーバ。
どの IP アドレスで待ち受けるかは <code>/etc/dovecot/dovecot.conf</code> にあるので
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">...
<span class="n">listen</span> = <span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span>
...</code></pre></figure>
<p>
あたりを修正しておく。
</p>

<p>
認証は
<code>/etc/dovecot/conf.d/10-auth.conf</code> 内で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">disable_plain_text_auth</span> = <span class="n">no</span>
<span class="n">auth_mechanisms</span> = <span class="n">plain</span>
!<span class="n">include</span> <span class="n">auth</span>-<span class="n">system</span>.<span class="n">conf</span>.<span class="n">ext</span></code></pre></figure>
<p>
を有効に。include されている auth-system.conf.ext の中身は
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">passdb</span> {
  <span class="n">driver</span> = <span class="n">pam</span>
}
<span class="n">userdb</span> {
  <span class="n">driver</span> = <span class="n">passwd</span>
}</code></pre></figure>
<p>
だけが有効。これで pam 経由でパスワードログインするようになる.
</p>

<p>
次に Maildir の設定。 <code>/etc/dovecot/conf.d/10-mail.conf</code> 内で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">mail_location</span> = <span class="n">maildir</span>:%<span class="n">h</span>/<span class="n">Maildir</span>:<span class="n">INBOX</span>=%<span class="n">h</span>/<span class="n">Maildir</span>/<span class="n">INBOX</span>:<span class="n">LAYOUT</span>=<span class="n">fs</span>
<span class="n">namespace</span> <span class="n">inbox</span> {
  <span class="n">inbox</span> = <span class="n">yes</span>
}</code></pre></figure>
<p>
あたりを修正しておく。
</p>

<p>
最後に IMAP over SSL の設定。 <code>/etc/dovecot/conf.d/10-ssl.conf</code> で証明書の設定をする:
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">ssl_cert</span> = &lt;/<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">private</span>/<span class="n">ssl</span>-<span class="n">cert</span>-<span class="n">dovecot</span>.<span class="n">pem</span>
<span class="n">ssl_key</span> = &lt;/<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">private</span>/<span class="n">ssl</span>-<span class="n">cert</span>-<span class="n">dovecot</span>.<span class="n">key</span>
<span class="n">ssl_protocols</span> = !<span class="n">SSLv2</span> !<span class="n">SSLv3</span></code></pre></figure>
<p>
その後に <code>/etc/dovecot/conf.d/10-master.conf</code> 内の <code>imap-login</code> 部分を修正
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">service</span> <span class="n">imap</span>-<span class="n">login</span> {
  <span class="n">inet_listener</span> <span class="n">imap</span> {
    <span class="n">port</span> = <span class="m">0</span>
    <span class="n">ssl</span> = <span class="n">no</span>
  }
  <span class="n">inet_listener</span> <span class="n">imaps</span> {
    <span class="n">port</span> = <span class="m">993</span>
    <span class="n">ssl</span> = <span class="n">yes</span>
  }
}</code></pre></figure>
<p>
これで再起動すると <code>/etc/ssl/private</code> に置いた SSL 証明書を使って <code>127.0.1.1:993</code> で IMAP サーバが起動する。Listen を 127.0.0.1 に絞るなら SSL でのアクセスは不要かもしれない。
</p>
</div>
</div>
</div>
<div>
<h3 id="org9d74f665">以下, obsolete</h3>
<div class="outline-text-3" id="text-org9d74f665">
<p>
検索は mu (maildir-utils) を使うようになったし,
メールの同期には mbsync を使うようになったので, 以下は昔のお話.
</p>
</div>
<div>
<h4 id="org7b190bb8">検索: Solr</h4>
<div class="outline-text-4" id="text-org7b190bb8">
<p>
Dovecot には FTS(Full Text Search) 用の plugin が幾つかある。
ここでは Solr を試してみる
</p>

<p>
とりあえず jetty で solar を動かすことに:
</p>
<pre class="example">
% sudo aptitude -R solr-jetty dovecot-solr
</pre>

<p>
Jetty の起動設定は <code>/etc/default/jetty8</code> にあるので
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">NO_START</span>=<span class="m">0</span>
<span class="n">JETTY_HOST</span>=<span class="n">localhost</span>
<span class="n">JETTY_PORT</span>=<span class="m">8089</span></code></pre></figure>
<p>
としておく。dovecot 用の scheme.xml は <code>dovecot-solr</code> をインストールすると <code>/usr/share/dovecot/solr-scheme.xml</code> にインストールされるので、これを <code>/etc/solr/conf/scheme.xml</code> にコピー
</p>
<pre class="example">
% cd /etc/solr/conf
% sudo cp scheme.xml scheme.xml.bak
% sudo cp /usr/share/dovecot/solr-schemex.ml scheme.xml
</pre>
<p>
その後で <code>/etc/dovecot/conf.d/10-imap.conf</code> 内の mail<sub>plugins</sub> 行に
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">mail_plugins</span> = <span class="n">fts</span> <span class="n">fts_solr</span></code></pre></figure>
<p>
を追加しておく。
IMAP でしか使わないのであれば <code>20-imap.conf</code> に指定すれば良いのだが、この場合は <code>doveadm fts rescan -u USERNAME</code> ができない。
最後に <code>/etc/dovecot/conf.d/90-plugin.conf</code> で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">plugin</span> {
  <span class="n">fts_autoindex</span> = <span class="n">yes</span>
  <span class="n">fts</span> = <span class="n">solr</span>
  <span class="n">fts_solr</span> = <span class="n">break</span>-<span class="n">imap</span>-<span class="n">search</span> <span class="n">url</span>=<span class="n">http</span>://<span class="n">localhost</span>:<span class="m">8089</span>/<span class="n">solr</span>/
}</code></pre></figure>
<p>
としておく。これで jetty8 および dovecot を再起動すると、検索が効く様になる…?
</p>
</div>
</div>
<div>
<h4 id="orgc1f4a23a">検索: Solr で日本語</h4>
<div class="outline-text-4" id="text-orgc1f4a23a">
<p>
<code>scheme.xml</code> の修正が必要。
とりあえず
</p>
<ul class="org-ul">
<li>
<code>/etc/solr/conf/scheme.xml</code> より <code>text_cjk</code> および <code>text_ja</code> の部分を抜き出して, dovecot の提供していた <code>scheme.xml</code> に追加</li>
<li>
<code>hdr,body,subject</code> を <code>text_cjk</code> で解析するように</li>
</ul>
<p>
してみた.
</p>

<p>
diff は以下:
</p>
<figure class="highlight"><pre><code class="language-diff" data-lang="diff"><span class="gd">--- solr-schema.xml 2015-05-10 20:52:33.375358006 +0900
</span><span class="gi">+++ schema.xml  2015-05-10 20:37:37.358195292 +0900
</span><span class="p">@@ -13,6 +13,62 @@</span>
     &lt;fieldType name="long" class="solr.TrieLongField" /&gt;
     &lt;fieldType name="boolean" class="solr.BoolField" /&gt;
<span class="err">
</span><span class="gi">+    &lt;!-- CJK bigram (see text_ja for a Japanese configuration using morphological analysis) --&gt;
+    &lt;fieldType name="text_cjk" class="solr.TextField" positionIncrementGap="100"&gt;
+      &lt;analyzer&gt;
+        &lt;tokenizer class="solr.StandardTokenizerFactory"/&gt;
+        &lt;!-- normalize width before bigram, as e.g. half-width dakuten combine  --&gt;
+        &lt;filter class="solr.CJKWidthFilterFactory"/&gt;
+        &lt;!-- for any non-CJK --&gt;
+        &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
+        &lt;filter class="solr.CJKBigramFilterFactory"/&gt;
+      &lt;/analyzer&gt;
+    &lt;/fieldType&gt;
+    &lt;fieldType name="text_ja" class="solr.TextField" positionIncrementGap="100" autoGeneratePhraseQueries="false"&gt;
+      &lt;analyzer&gt;
+      &lt;!-- Kuromoji Japanese morphological analyzer/tokenizer (JapaneseTokenizer)
+
+           Kuromoji has a search mode (default) that does segmentation useful for search.  A heuristic
+           is used to segment compounds into its parts and the compound itself is kept as synonym.
+
+           Valid values for attribute mode are:
+              normal: regular segmentation
+              search: segmentation useful for search with synonyms compounds (default)
+            extended: same as search mode, but unigrams unknown words (experimental)
+
+           For some applications it might be good to use search mode for indexing and normal mode for
+           queries to reduce recall and prevent parts of compounds from being matched and highlighted.
+           Use &lt;analyzer type="index"&gt; and &lt;analyzer type="query"&gt; for this and mode normal in query.
+
+           Kuromoji also has a convenient user dictionary feature that allows overriding the statistical
+           model with your own entries for segmentation, part-of-speech tags and readings without a need
+           to specify weights.  Notice that user dictionaries have not been subject to extensive testing.
+
+           User dictionary attributes are:
+                     userDictionary: user dictionary filename
+             userDictionaryEncoding: user dictionary encoding (default is UTF-8)
+
+           See lang/userdict_ja.txt for a sample user dictionary file.
+
+           See http://wiki.apache.org/solr/JapaneseLanguageSupport for more on Japanese language support.
+        --&gt;
+        &lt;tokenizer class="solr.JapaneseTokenizerFactory" mode="search"/&gt;
+        &lt;!--&lt;tokenizer class="solr.JapaneseTokenizerFactory" mode="search" userDictionary="lang/userdict_ja.txt"/&gt;--&gt;
+        &lt;!-- Reduces inflected verbs and adjectives to their base/dictionary forms (辞書形) --&gt;
+        &lt;filter class="solr.JapaneseBaseFormFilterFactory"/&gt;
+        &lt;!-- Removes tokens with certain part-of-speech tags --&gt;
+        &lt;filter class="solr.JapanesePartOfSpeechStopFilterFactory" tags="lang/stoptags_ja.txt" enablePositionIncrements="true"/&gt;
+        &lt;!-- Normalizes full-width romaji to half-width and half-width kana to full-width (Unicode NFKC subset) --&gt;
+        &lt;filter class="solr.CJKWidthFilterFactory"/&gt;
+        &lt;!-- Removes common tokens typically not useful for search, but have a negative effect on ranking --&gt;
+        &lt;filter class="solr.StopFilterFactory" ignoreCase="true" words="lang/stopwords_ja.txt" enablePositionIncrements="true" /&gt;
+        &lt;!-- Normalizes common katakana spelling variations by removing any last long sound character (U+30FC) --&gt;
+        &lt;filter class="solr.JapaneseKatakanaStemFilterFactory" minimumLength="4"/&gt;
+        &lt;!-- Lower-cases romaji characters --&gt;
+        &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
+      &lt;/analyzer&gt;
+    &lt;/fieldType&gt;
+
</span>     &lt;fieldType name="text" class="solr.TextField" positionIncrementGap="100"&gt;
       &lt;analyzer type="index"&gt;
         &lt;tokenizer class="solr.StandardTokenizerFactory"/&gt;
<span class="p">@@ -43,14 +99,14 @@</span>
    &lt;field name="box" type="string" indexed="true" stored="true" required="true" /&gt;
    &lt;field name="user" type="string" indexed="true" stored="true" required="true" /&gt;
<span class="err">
</span><span class="gd">-   &lt;field name="hdr" type="text" indexed="true" stored="false" /&gt;
-   &lt;field name="body" type="text" indexed="true" stored="false" /&gt;
</span><span class="gi">+   &lt;field name="hdr" type="text_cjk" indexed="true" stored="false" /&gt;
+   &lt;field name="body" type="text_cjk" indexed="true" stored="false" /&gt;
</span><span class="err">
</span>    &lt;field name="from" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="to" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="cc" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="bcc" type="text" indexed="true" stored="false" /&gt;
<span class="gd">-   &lt;field name="subject" type="text" indexed="true" stored="false" /&gt;
</span><span class="gi">+   &lt;field name="subject" type="text_cjk" indexed="true" stored="false" /&gt;
</span><span class="err">
</span>    &lt;!-- Used by Solr internally: --&gt;
    &lt;field name="_version_" type="long" indexed="true" stored="true"/&gt;</code></pre></figure>
</div>
</div>
<div>
<h4 id="org56239831">offlineimap</h4>
<div class="outline-text-4" id="text-org56239831">
<p>
(2015/05/10) 以前使っていた時のメモ。もう使わないけれど、たまに検索でココを見に来ている人がいるみたいなので、残しておくことに。
<a href="http://offlineimap.org/">OfflineIMAP</a> は,ネットワーク上にあるIMAPサーバと手元のMaildir/IMAPサーバの同期を取るためのソフトウェア.
</p>
</div>
<ul class="org-ul">
<li>インストール: offlineimap<br>
<div class="outline-text-5" id="text-org9a0058d3">
<p>
apt万歳, ってことで.
</p>
<pre class="example">
$ sudo apt-get install offlineimap
</pre>
</div>
</li>
<li>設定: offlineimap<br>
<div class="outline-text-5" id="text-org9ebeeb17">
<p>
現状, 以下の通り:
</p>
<ul class="org-ul">
<li>
<a href="http://offlineimap.org/">OfflineIMAP</a> のメタ情報は <code>~/Mail/offlineimap</code> 以下に格納</li>
<li>同期するサーバは二箇所:
<ul class="org-ul">
<li>Main サーバのメールは <code>~/Mail/imap</code> 以下に格納.
<ul class="org-ul">
<li>この際, IMAP Namespace である <code>INBOX.</code> を除外して <code>Maildir</code> を作成</li>
<li>
<code>~/Mail/imap/[Gmail]</code> は同期しない</li>
</ul>
</li>
<li>Gmail のメールは <code>~/Mail/imap/[Gmail]/</code> 以下に格納</li>
</ul>
</li>
</ul>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="c"># -*- mode: conf; coding: utf-8-unix; indent-tabs-mode: nil -*-
# offlineimaprc
#
# Copyright(C) 2011 Youhei SASAKI All rights reserved.
# $Lastupdate: 2014-07-26 18:25:07$
#
# Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;
# License: WTFPL
#
# Code:
</span>[<span class="n">general</span>]
<span class="c"># メタデータの格納先
</span><span class="n">metadata</span> = ~/<span class="n">Mail</span>/<span class="n">offlineimap</span>
<span class="c"># 補助関数が定義されたファイルの置き場所
</span><span class="n">pythonfile</span> = ~/.<span class="n">mua</span>/<span class="n">offlineimap_utils</span>.<span class="n">py</span>
<span class="c"># 同期するサーバの設定
</span><span class="n">accounts</span> = <span class="n">Main</span>, <span class="n">Gmail</span>
<span class="c"># 同期するアカウントの数
</span><span class="n">maxsyncaccounts</span> = <span class="m">2</span>
<span class="c"># UI の設定. cron で同期する場合には quiet の方が良い
</span><span class="n">ui</span> = <span class="n">basic</span>
<span class="n">socktimeout</span> = <span class="m">600</span>
<span class="c"># 高速化(?)
</span><span class="n">fsync</span> = <span class="n">false</span>

<span class="c"># Gmail 用の設定: ここで設定する名前は accounts に揃える
</span>[<span class="n">Account</span> <span class="n">Gmail</span>]
<span class="n">localrepository</span> = <span class="n">LocalGmail</span>
<span class="n">remoterepository</span> = <span class="n">RemoteGmail</span>
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">status_backend</span> = <span class="n">sqlite</span>
<span class="c"># quick = 1 だとフラグは同期されない
# '[Gmail]/全てのメール' を同期するなら quick = 1 の方が良い?
</span><span class="n">quick</span> = <span class="m">0</span>

[<span class="n">Repository</span> <span class="n">LocalGmail</span>]
<span class="c"># Gmail の手元の設定
</span><span class="n">type</span> = <span class="n">Maildir</span>
<span class="c"># Maildir の格納場所
</span><span class="n">localfolders</span> = ~/<span class="n">Mail</span>/<span class="n">imap</span>/[<span class="n">Gmail</span>]
<span class="n">restoreatime</span> = <span class="n">no</span>
<span class="c"># IMAP のセパレータの変換: Mailbox の "." が "/" となり,
# ディレクトリが作成される
</span><span class="n">sep</span> = /

[<span class="n">Repository</span> <span class="n">RemoteGmail</span>]
<span class="c"># Gmail との接続設定: type = IMAP でも良い?
</span><span class="n">type</span> = <span class="n">Gmail</span>
<span class="c"># remote{pass,user}eval は offlineimap_utils.py で定義した関数
</span><span class="n">remoteusereval</span> = <span class="n">get_username</span>(<span class="s2">"imap.gmail.com"</span>)
<span class="n">remotepasseval</span> = <span class="n">get_password</span>(<span class="s2">"imap.gmail.com"</span>)
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">realdelete</span> = <span class="n">no</span>
<span class="c"># 同時接続数. 並列実行可能なので適宜
# サーバに怒られない程度に
</span><span class="n">maxconnections</span> = <span class="m">5</span>
<span class="c"># remote -&gt; local 時のフォルダ名変換(正規表現)
</span><span class="n">nametrans</span> = <span class="n">lambda</span> <span class="n">foldername</span>: <span class="n">re</span>.<span class="n">sub</span>(<span class="s1">'^INBOX'</span>,<span class="s1">''</span>, (<span class="n">re</span>.<span class="n">sub</span>(<span class="s1">'^\[Gmail\]/'</span>,<span class="s1">''</span>, <span class="n">foldername</span>)))
<span class="c"># 同期するフォルダの設定: Gmail 側で IMAP で表示するラベル設定しておく, でも良いかも.
</span><span class="n">folderfilter</span> = <span class="n">lambda</span> <span class="n">foldername</span>: <span class="n">foldername</span> <span class="n">in</span> [
             <span class="s1">'INBOX'</span>,                   <span class="c"># -&gt; '~/Mail/imap/[Gmail]' になる
</span>             <span class="s1">'[Gmail]/&amp;j,dg0TDhMPww6w-'</span> <span class="c"># -&gt; '~/Mail/imap/[Gmail]/&amp;j,dg0TDhMPww6w-' になる
</span>             ]
<span class="n">sslcacertfile</span> = /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="c"># Main サーバの設定: ここで設定する名前は [general] accounts に揃える
</span>[<span class="n">Account</span> <span class="n">Main</span>]
<span class="n">localrepository</span> = <span class="n">LocalMain</span>
<span class="n">remoterepository</span> = <span class="n">RemoteMain</span>
<span class="n">status_backend</span> = <span class="n">sqlite</span>
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">quick</span> = <span class="m">0</span>

[<span class="n">Repository</span> <span class="n">LocalMain</span>]
<span class="c"># 手元の設定
</span><span class="n">type</span> = <span class="n">Maildir</span>
<span class="c"># Maildir の格納場所
</span><span class="n">localfolders</span> = ~/<span class="n">Mail</span>/<span class="n">imap</span>
<span class="n">restoreatime</span> = <span class="n">no</span>
<span class="c"># local -&gt; remote での名前変換
# LocaltoRemoteTransnameINBOX は offlineimap_utils.py で定義した関数
</span><span class="n">nametrans</span> = <span class="n">LocalToRemoteTransnameINBOX</span>
<span class="c"># 'Maildir/imap/[Gmail]' は同期しない
</span><span class="n">folderfilter</span> = <span class="n">lambda</span> <span class="n">folder</span>: <span class="n">not</span> <span class="n">folder</span>.<span class="n">startswith</span>(<span class="s1">'[Gmail]'</span>)
<span class="n">sep</span> = /

[<span class="n">Repository</span> <span class="n">RemoteMain</span>]
<span class="n">type</span> = <span class="n">IMAP</span>
<span class="n">ssl</span> = <span class="n">yes</span>
<span class="c"># certificates がデフォルトで探せない?
</span><span class="n">sslcacertfile</span> = /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>
<span class="n">remotehost</span> = [<span class="n">main</span> <span class="n">server</span>]
<span class="c"># remote{pass,user}eval は offlineimap_utils.py で定義した関数
</span><span class="n">remoteusereval</span> = <span class="n">get_username</span>(<span class="s2">"[main server]"</span>)
<span class="n">remotepasseval</span> = <span class="n">get_password</span>(<span class="s2">"[main server]"</span>)
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">maxconnections</span> = <span class="m">5</span>
<span class="c"># remote -&gt; local での名前の変換
# RemotetoLocalTransnameINBOX は offlineimap_utils.py で定義した関数
</span><span class="n">nametrans</span> = <span class="n">RemoteToLocalTransnameINBOX</span>
<span class="c"># 同期 *しない* フォルダの選択
</span><span class="n">folderfilter</span> = <span class="n">lambda</span> <span class="n">foldername</span>: <span class="n">foldername</span> <span class="n">not</span> <span class="n">in</span> [
            <span class="s1">'INBOX.Drafts'</span>,
            <span class="s1">'INBOX.Trash'</span>,
            <span class="s1">'INBOX.archive.zz2006'</span>,
            <span class="s1">'INBOX.archive.zz2007'</span>,
            <span class="s1">'INBOX.archive.zz2008'</span>,
            <span class="s1">'INBOX.archive.zz2009'</span>,
            <span class="s1">'INBOX.archive.zz2010'</span>,
            <span class="s1">'INBOX.archive.zz2011'</span>,
            <span class="s1">'INBOX.archive.zz2012'</span>,
            <span class="s1">'INBOX.archive.zz2013'</span>
            ]</code></pre></figure>
<p>
<code>offlineimap_utils.py</code> の中身は以下の通り:
</p>
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python
# -*- coding: utf-8
</span><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="c1"># # Auth via GnomeKeyring
</span><span class="kn">import</span> <span class="n">gtk</span>
<span class="kn">from</span> <span class="n">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="n">gnomekeyring</span> <span class="k">as</span> <span class="n">gkey</span>
<span class="c1"># Ad hoc fix for Striptime behavior
</span><span class="kn">import</span> <span class="n">locale</span>
<span class="n">locale</span><span class="p">.</span><span class="nf">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="p">.</span><span class="n">LC_TIME</span><span class="p">,</span> <span class="s">'C'</span><span class="p">)</span>

<span class="c1">##################
# Gnome keyring  #
##################
</span>
<span class="k">class</span> <span class="nc">Keyring</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_keyring</span> <span class="o">=</span> <span class="n">gkey</span><span class="p">.</span><span class="nf">get_default_keyring_sync</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_credentials</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"server"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_server</span><span class="p">,</span> <span class="s">"protocol"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_protocol</span><span class="p">}</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">gkey</span><span class="p">.</span><span class="nf">find_items_sync</span><span class="p">(</span><span class="n">gkey</span><span class="p">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="n">gkey</span><span class="p">.</span><span class="n">DeniedError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_credentials</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"server"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_server</span><span class="p">,</span> <span class="s">"protocol"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_protocol</span><span class="p">}</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">gkey</span><span class="p">.</span><span class="nf">find_items_sync</span><span class="p">(</span><span class="n">gkey</span><span class="p">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">attributes</span><span class="p">[</span><span class="s">"user"</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">secret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_credentials</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"user"</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                <span class="s">"server"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_server</span><span class="p">,</span>
                <span class="s">"protocol"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_protocol</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">gkey</span><span class="p">.</span><span class="nf">item_create_sync</span><span class="p">(</span><span class="n">gkey</span><span class="p">.</span><span class="nf">get_default_keyring_sync</span><span class="p">(),</span>
                <span class="n">gkey</span><span class="p">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_username</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">keyring</span> <span class="o">=</span> <span class="nc">Keyring</span><span class="p">(</span><span class="s">"offlineimap"</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s">"imap"</span><span class="p">)</span>
    <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=</span> <span class="n">keyring</span><span class="p">.</span><span class="nf">get_credentials</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">username</span>

<span class="k">def</span> <span class="nf">get_password</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">keyring</span> <span class="o">=</span> <span class="nc">Keyring</span><span class="p">(</span><span class="s">"offlineimap"</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s">"imap"</span><span class="p">)</span>
    <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=</span> <span class="n">keyring</span><span class="p">.</span><span class="nf">get_credentials</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">password</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
        <span class="n">server</span> <span class="o">=</span> <span class="nf">raw_input</span><span class="p">(</span><span class="s">"server: "</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nf">raw_input</span><span class="p">(</span><span class="s">"username: "</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="nf">getpass</span><span class="p">(</span><span class="s">"password: "</span><span class="p">)</span>
        <span class="n">confirm</span> <span class="o">=</span> <span class="nf">getpass</span><span class="p">(</span><span class="s">"confirm password: "</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"password doesn't match confirmation!"</span>
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">keyring</span> <span class="o">=</span> <span class="nc">Keyring</span><span class="p">(</span><span class="s">"offlineimap"</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s">"imap"</span><span class="p">)</span>
        <span class="n">keyring</span><span class="p">.</span><span class="nf">set_credentials</span><span class="p">((</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

<span class="c1">############################
# NameTrans 'INBOX' suffix #
############################
# add 'INBOX' suffix
</span><span class="k">def</span> <span class="nf">LocalToRemoteTransnameINBOX</span><span class="p">(</span><span class="n">foldername</span><span class="p">):</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">foldername</span> <span class="o">==</span> <span class="s">""</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">"INBOX"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">"INBOX."</span> <span class="o">+</span> <span class="n">foldername</span>
    <span class="k">return</span> <span class="n">retval</span>

<span class="c1"># remove 'INBOX' suffix
</span><span class="k">def</span> <span class="nf">RemoteToLocalTransnameINBOX</span><span class="p">(</span><span class="n">foldername</span><span class="p">):</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">foldername</span> <span class="o">==</span> <span class="s">"INBOX"</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="s">"^INBOX\."</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">foldername</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retval</span></code></pre></figure>
<p>
IMAP の名前空間が複雑な(?)場合には, 適宜正規表現を追加すると良い.
</p>
</div>
</li>
<li>cron での動作: offlineimap<br>
<div class="outline-text-5" id="text-org79b6cb1b">
<p>
認証に GnomeKeyring を使っているので <code>DBUS_SESSION_BUS_ADDRESS</code> を設定してから
実行するようにする.
先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>
<span class="nb">sleep </span>5
<span class="c"># Export the dbus session address on startup so it can be used by cron</span>
<span class="nb">touch</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">chmod </span>600 <span class="nv">$HOME</span>/.Xdbus
<span class="nb">env</span> | <span class="nb">grep </span>DBUS_SESSION_BUS_ADDRESS <span class="o">&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">'export DBUS_SESSION_BUS_ADDRESS'</span> <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus</code></pre></figure>
<p>
<code>~/.config/autostart</code> 以下に適当な名前で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">[<span class="n">Desktop</span> <span class="n">Entry</span>]
<span class="n">Type</span>=<span class="n">Application</span>
<span class="n">Exec</span>=/<span class="n">home</span>/<span class="n">uwabami</span>/.<span class="n">mua</span>/<span class="n">export_x_info</span>.<span class="n">sh</span>
<span class="n">Hidden</span>=<span class="n">false</span>
<span class="n">NoDisplay</span>=<span class="n">false</span>
<span class="n">X</span>-<span class="n">GNOME</span>-<span class="n">Autostart</span>-<span class="n">enabled</span>=<span class="n">true</span>
<span class="n">Name</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
<span class="n">Comment</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span></code></pre></figure>
<p>
を用意しておく.
</p>

<p>
あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
必要に応じて GnomeKeyring による認証が行なわれる.
cron で実行されるスクリプトは, 例えば
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="c"># -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-</span>
<span class="c"># $Lastupdate: 2014-07-15 11:52:22$</span>
<span class="c"># Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;</span>
<span class="c"># License: WTFPL</span>
<span class="c">################################################################################</span>
<span class="c"># for personal settings</span>
<span class="nv">OFFLINEIMAP_PID</span><span class="o">=</span>~/Mail/offlineimap/pid
<span class="nv">OFFLINEIMAP_CONF</span><span class="o">=</span>~/.offlineimaprc
<span class="nv">UI</span><span class="o">=</span>quiet
<span class="nb">echo</span> <span class="s2">"******************************************************************"</span>
<span class="nb">echo</span> <span class="sb">`</span><span class="nv">LANG</span><span class="o">=</span>C <span class="nb">date</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"******************************************************************"</span>
<span class="c"># for gnome-keyring:</span>
<span class="nb">.</span> <span class="k">${</span><span class="nv">HOME</span><span class="k">}</span>/.Xdbus
<span class="c"># check network is avaliable</span>
nm-online <span class="nt">-x</span> <span class="o">||</span> <span class="nb">exit </span>0
<span class="c"># check another offlineimap</span>
<span class="o">[</span> <span class="si">$(</span>ps <span class="nt">-p</span> <span class="sb">`</span><span class="nb">cat</span> <span class="nv">$OFFLINEIMAP_PID</span><span class="sb">`</span> <span class="nt">-o</span> pid <span class="nt">--no-heading</span><span class="si">)</span> <span class="o">]</span> <span class="se">\</span>
  <span class="o">||</span> <span class="nb">nice</span> <span class="nt">-n</span> 19 offlineimap <span class="nt">-c</span> <span class="nv">$OFFLINEIMAP_CONF</span> <span class="nt">-u</span> <span class="nv">$UI</span> <span class="nt">-o</span>  2&gt;&amp;1</code></pre></figure>
<p>
とか.
</p>
</div>
</li>
</ul>
</div>
</div>
</div>

        </div>
      </main>
      <a href="#" class="back_to_top">Back to Top &#9650;</a>
      <hr/>
      <footer>
        <p>&copy; 2006-2021
  <a href="mailto:uwabami@gfd-dennou.org">Youhei SASAKI</a>,
  Lastupdate: 2021-08-13 21:59:54 +0000
  <br/>
  Powered by
  <a href="https://orgmode.org/" rel="noopener" title="Org mode">
    Org mode
  </a>
  +
  <a href="https://jekyllrb.com/" rel="noopener" title="Jekyll">
    Jekyll
  </a>
  +
  <a href="https://picocss.com/" rel="noopener" title="pico.css">
    Pico.css
  </a>
  &amp;
  <a href="https://amp.dev/">
    <span class="icon-amp">⚡</span>AMP
  </a>
</p>

      </footer>
    </div>
    <amp-analytics data-block-on-consent
               type="googleanalytics"
               config="https://uwabami.github.io/assets/ga4.json"
               data-credentials="include"
		       data-block-on-consent>
  <script type="application/json">
    {
        "vars": {
            "GA4_MEASUREMENT_ID": "G-CLB2VW9XEW",
            "GA4_ENDPOINT_HOSTNAME": "www.google-analytics.com",
            "DEFAULT_PAGEVIEW_ENABLED": true,
            "GOOGLE_CONSENT_ENABLED": true,
            "WEBVITALS_TRACKING": false,
            "PERFORMANCE_TIMING_TRACKING": false
        }
    }
  </script>
</amp-analytics>

  </body>
</html>
