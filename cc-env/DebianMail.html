<!doctype html>
<html ⚡ lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="preconnect dns-prefetch" href="//cdn.ampproject.org" crossorigin>
    <link rel="preconnect dns-prefetch" href="//uwabami.github.io/" crossorigin>
    <!-- amp preload -->
    <link rel="preload" as="script" href="https://cdn.ampproject.org/v0.js">
    <link rel="preload" as="image" href="/assets/img/top.png">
    <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/inconsolata-v18-latin-regular.woff2" crossorigin>
    <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/inconsolata-v18-latin-700.woff2" crossorigin>
    <link rel="preload" as="font" type="font/woff2" href="/assets/fonts/ComicNeueSubset.woff2" crossorigin>
    <!-- end amp preload -->
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script async custom-element="amp-geo" src="https://cdn.ampproject.org/v0/amp-geo-0.1.js"></script>
    <script async custom-element="amp-consent" src="https://cdn.ampproject.org/v0/amp-consent-0.1.js"></script>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-form" src="https://cdn.ampproject.org/v0/amp-form-0.1.js"></script>
    <!-- Custom css based on following two framework -->
    <!-- - normalize.css v5.0.0 | MIT License | github.com/necolas/normalize.css -->
    <!-- - basscss v8.1.2 | MIT License | github.com/basscss/basscss -->
    <style amp-custom>@font-face{font-family:'Inconsolata';font-style:normal;font-weight:400;font-display:swap;src:local("Inconsolata Regular"),local("Inconsolata-Regular"),url("/assets/fonts/inconsolata-v18-latin-regular.woff2") format("woff2")}@font-face{font-family:'Inconsolata';font-style:Bold;font-weight:700;font-display:swap;src:local("Inconsolata Bold"),local("Inconsolata-Bold"),url("/assets/fonts/inconsolata-v18-latin-700.woff2") format("woff2")}@font-face{font-family:'Isfit+';font-style:normal;font-weight:400;font-display:swap;src:local("isfit+"),local("isfit-plus"),url("/assets/fonts/isfit-plus.woff2") format("woff2")}@font-face{font-family:'Comic Neue';font-style:normal;font-weight:400;font-display:swap;src:local("Comic Neue"),local("Comic Neue"),url("/assets/fonts/ComicNeueSubset.woff2") format("woff2")}@font-face{font-family:'AoyagiKouzanTSubset';font-style:normal;font-weight:400;font-display:swap;src:local("AoyagiKouzanTSubset"),local("AoyagiKouzanTSubset"),url("/assets/fonts/AoyagiKouzanTSubset.woff2") format("woff2")}@font-face{font-family:YuGothicM;src:local(Yu Gothic Medium)}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:0.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:"Inconsolata",YuGothic,"游ゴシック体","游ゴシック","YuGothic M","メイリオ",Meiryo,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",Symbola,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:"Inconsolata",YuGothic,"游ゴシック体","游ゴシック","YuGothic M","メイリオ",Meiryo,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",Symbola,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:0.35em 0.75em 0.625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}.h00{font-size:4rem}.h0{font-size:3rem}.h1{font-size:2rem}.h2{font-size:1.5rem}.h3{font-size:1.25rem}.h4{font-size:1rem}.h5{font-size:.875rem}.h6{font-size:.75rem}.font-family-inherit{font-family:inherit}.font-size-inherit{font-size:inherit}.text-decoration-none{text-decoration:none}.bold{font-weight:700}.regular{font-weight:normal}.italic{font-style:italic}.caps{text-transform:uppercase;letter-spacing:.2em}.left-align{text-align:left}.center{text-align:center}.right-align{text-align:right}.justify{text-align:justify}.nowrap{white-space:nowrap}.break-word{word-wrap:break-word}.line-height-1{line-height:1}.line-height-2{line-height:1.125}.line-height-3{line-height:1.25}.line-height-4{line-height:1.5}.list-style-none{list-style:none}.underline{text-decoration:underline}.truncate{max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.list-reset{list-style:none;padding-left:0}.inline{display:inline}.block{display:block}.inline-block{display:inline-block}.table{display:table}.table-cell{display:table-cell}.overflow-hidden{overflow:hidden}.overflow-scroll{overflow:scroll}.overflow-auto{overflow:auto}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.left{float:left}.right{float:right}.fit{max-width:100%}.max-width-1{max-width:320px}.max-width-2{max-width:480px}.max-width-3{max-width:600px}.max-width-4{max-width:800px}.border-box{box-sizing:border-box}.align-baseline{vertical-align:baseline}.align-top{vertical-align:top}.align-middle{vertical-align:middle}.align-bottom{vertical-align:bottom}.m0{margin:0}.mt0{margin-top:0}.mr0{margin-right:0}.mb0{margin-bottom:0}.ml0{margin-left:0}.mx0{margin-left:0;margin-right:0}.my0{margin-top:0;margin-bottom:0}.m1{margin:.5rem}.mt1{margin-top:.5rem}.mr1{margin-right:.5rem}.mb1{margin-bottom:.5rem}.ml1{margin-left:.5rem}.mx1{margin-left:.5rem;margin-right:.5rem}.my1{margin-top:.5rem;margin-bottom:.5rem}.m2{margin:1rem}.mt2{margin-top:1rem}.mr2{margin-right:1rem}.mb2{margin-bottom:1rem}.ml2{margin-left:1rem}.mx2{margin-left:1rem;margin-right:1rem}.my2{margin-top:1rem;margin-bottom:1rem}.m3{margin:2rem}.mt3{margin-top:2rem}.mr3{margin-right:2rem}.mb3{margin-bottom:2rem}.ml3{margin-left:2rem}.mx3{margin-left:2rem;margin-right:2rem}.my3{margin-top:2rem;margin-bottom:2rem}.m4{margin:4rem}.mt4{margin-top:4rem}.mr4{margin-right:4rem}.mb4{margin-bottom:4rem}.ml4{margin-left:4rem}.mx4{margin-left:4rem;margin-right:4rem}.my4{margin-top:4rem;margin-bottom:4rem}.mxn1{margin-left:-.5rem;margin-right:-.5rem}.mxn2{margin-left:-1rem;margin-right:-1rem}.mxn3{margin-left:-2rem;margin-right:-2rem}.mxn4{margin-left:-4rem;margin-right:-4rem}.m-auto{margin:auto}.mt-auto{margin-top:auto}.mr-auto{margin-right:auto}.mb-auto{margin-bottom:auto}.ml-auto{margin-left:auto}.mx-auto{margin-left:auto;margin-right:auto}.my-auto{margin-top:auto;margin-bottom:auto}.p0{padding:0}.pt0{padding-top:0}.pr0{padding-right:0}.pb0{padding-bottom:0}.pl0{padding-left:0}.px0{padding-left:0;padding-right:0}.py0{padding-top:0;padding-bottom:0}.p1{padding:.5rem}.pt1{padding-top:.5rem}.pr1{padding-right:.5rem}.pb1{padding-bottom:.5rem}.pl1{padding-left:.5rem}.py1{padding-top:.5rem;padding-bottom:.5rem}.px1{padding-left:.5rem;padding-right:.5rem}.p2{padding:1rem}.pt2{padding-top:1rem}.pr2{padding-right:1rem}.pb2{padding-bottom:1rem}.pl2{padding-left:1rem}.py2{padding-top:1rem;padding-bottom:1rem}.px2{padding-left:1rem;padding-right:1rem}.p3{padding:2rem}.pt3{padding-top:2rem}.pr3{padding-right:2rem}.pb3{padding-bottom:2rem}.pl3{padding-left:2rem}.py3{padding-top:2rem;padding-bottom:2rem}.px3{padding-left:2rem;padding-right:2rem}.p4{padding:4rem}.pt4{padding-top:4rem}.pr4{padding-right:4rem}.pb4{padding-bottom:4rem}.pl4{padding-left:4rem}.py4{padding-top:4rem;padding-bottom:4rem}.px4{padding-left:4rem;padding-right:4rem}.col{float:left;box-sizing:border-box}.col-right{float:right;box-sizing:border-box}.col-1{width:8.33333%}.col-2{width:16.66667%}.col-3{width:25%}.col-4{width:33.33333%}.col-5{width:41.66667%}.col-6{width:50%}.col-7{width:58.33333%}.col-8{width:66.66667%}.col-9{width:75%}.col-10{width:83.33333%}.col-11{width:91.66667%}.col-12{width:100%}@media (min-width: 40.06rem){.sm-col{float:left;box-sizing:border-box}.sm-col-right{float:right;box-sizing:border-box}.sm-col-1{width:8.33333%}.sm-col-2{width:16.66667%}.sm-col-3{width:25%}.sm-col-4{width:33.33333%}.sm-col-5{width:41.66667%}.sm-col-6{width:50%}.sm-col-7{width:58.33333%}.sm-col-8{width:66.66667%}.sm-col-9{width:75%}.sm-col-10{width:83.33333%}.sm-col-11{width:91.66667%}.sm-col-12{width:100%}}@media (min-width: 52.06rem){.md-col{float:left;box-sizing:border-box}.md-col-right{float:right;box-sizing:border-box}.md-col-1{width:8.33333%}.md-col-2{width:16.66667%}.md-col-3{width:25%}.md-col-4{width:33.33333%}.md-col-5{width:41.66667%}.md-col-6{width:50%}.md-col-7{width:58.33333%}.md-col-8{width:66.66667%}.md-col-9{width:75%}.md-col-10{width:83.33333%}.md-col-11{width:91.66667%}.md-col-12{width:100%}}@media (min-width: 64rem){.lg-col{float:left;box-sizing:border-box}.lg-col-right{float:right;box-sizing:border-box}.lg-col-1{width:8.33333%}.lg-col-2{width:16.66667%}.lg-col-3{width:25%}.lg-col-4{width:33.33333%}.lg-col-5{width:41.66667%}.lg-col-6{width:50%}.lg-col-7{width:58.33333%}.lg-col-8{width:66.66667%}.lg-col-9{width:75%}.lg-col-10{width:83.33333%}.lg-col-11{width:91.66667%}.lg-col-12{width:100%}}.flex{display:-webkit-box;display:-ms-flexbox;display:flex}@media (min-width: 40.06rem){.sm-flex{display:-webkit-box;display:-ms-flexbox;display:flex}}@media (min-width: 52.06rem){.lg-flex{display:-webkit-box;display:-ms-flexbox;display:flex}}.flex-column{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.flex-wrap{-ms-flex-wrap:wrap;flex-wrap:wrap}.items-start{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.items-end{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.items-center{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.items-baseline{-webkit-box-align:baseline;-ms-flex-align:baseline;align-items:baseline}.items-stretch{-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch}.self-start{align-self:flex-start}.self-end{align-self:flex-end}.self-center{align-self:center}.self-baseline{align-self:baseline}.self-stretch{align-self:stretch}.justify-start{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start}.justify-end{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end}.justify-center{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center}.justify-between{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.justify-around{-ms-flex-pack:distribute;justify-content:space-around}.justify-evenly{-webkit-box-pack:space-evenly;justify-content:space-evenly}.content-start{-ms-flex-line-pack:start;align-content:flex-start}.content-end{-ms-flex-line-pack:end;align-content:flex-end}.content-center{-ms-flex-line-pack:center;align-content:center}.content-between{-ms-flex-line-pack:justify;align-content:space-between}.content-around{-ms-flex-line-pack:distribute;align-content:space-around}.content-stretch{-ms-flex-line-pack:stretch;align-content:stretch}.flex-auto{-webkit-box-flex:1;-ms-flex-positive:1;flex:1 1 auto;min-width:0;min-height:0}.flex-none{-webkit-box-flex:0;-ms-flex-positive:0;flex:none}.order-0{-webkit-box-ordinal-group:1;-ms-flex-order:0;order:0}.order-1{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}.order-2{-webkit-box-ordinal-group:3;-ms-flex-order:2;order:2}.order-3{-webkit-box-ordinal-group:4;-ms-flex-order:3;order:3}.order-last{-webkit-box-ordinal-group:100000;-ms-flex-order:99999;order:99999}.relative{position:relative}.absolute{position:absolute}.fixed{position:fixed}.top-0{top:0}.right-0{right:0}.bottom-0{bottom:0}.left-0{left:0}.z1{z-index:1}.z2{z-index:2}.z3{z-index:3}.z4{z-index:4}.border{border-style:solid;border-width:1px;border-width:1px}.border-top{border-top-style:solid;border-top-width:1px}.border-right{border-right-style:solid;border-right-width:1px}.border-bottom{border-bottom-style:solid;border-bottom-width:1px}.border-left{border-left-style:solid;border-left-width:1px}.border-none{border:0}.rounded{border-radius:3px}.circle{border-radius:50%}.rounded-top{border-radius:3px 3px 0 0}.rounded-right{border-radius:0 3px 3px 0}.rounded-bottom{border-radius:0 0 3px 3px}.rounded-left{border-radius:3px 0 0 3px}.not-rounded{border-radius:0}.hide{position:absolute;height:1px;width:1px;overflow:hidden;clip:rect(1px, 1px, 1px, 1px)}@media (max-width: 40rem){.xs-hide{display:none}}@media (min-width: 40.06rem) and (max-width: 52.06rem){.sm-hide{display:none}}@media (min-width: 52.06rem) and (max-width: 64rem){.md-hide{display:none}}@media (min-width: 64rem){.lg-hide{display:none}}.display-none{display:none}h1{font-weight:normal}.content em{font-weight:normal;font-style:normal}.content strong{font-weight:normal;font-size:1.5rem}.content .alert{font-weight:bold;color:#ff4136}.content a:hover{text-decoration:underline}.content ol{counter-reset:list}.content ol>li{position:relative;list-style:none;margin-top:5px;margin-bottom:5px}.content dd{padding:0;margin-right:0;margin-left:15pt}.content ul>li{margin:5px 0 5px 0}.content ul{padding:0 20px 0 20px}.content ol{padding:0 30px 0 30px}.content ol>li:before{content:"(" counter(list, decimal) ") ";counter-increment:list;position:absolute;left:-35px}.content blockquote{border-left:5px solid #333333;margin:10px 0 10px 0;padding:0px 8px 0px 8px;font-style:normal}.content h2{border-bottom:1px solid #5af;font-weight:normal;margin:1rem 0 0 0;padding:0}.content h3{border-bottom:1px dashed #5af;font-weight:normal;margin:1rem 0 0 0}.content h4{border-bottom:1px dotted #5af;font-weight:normal;margin:1rem 0 0 0}.content h5{border-bottom:1px dashed #333333;font-weight:normal;font-size:1rem;margin:1rem 0 0 0}.content h6{border-bottom:1px dotted #333333;font-weight:normal;font-size:1rem;margin:1rem 0 0 0}.content p{text-align:justify;text-justify:inter-ideograph;hanging-punctuation:allow-end;font-feature-settings:"halt" 1}html{height:100%;-ms-text-size-adjust:100%;font-size:15pt;font-family:"Inconsolata",YuGothic,"游ゴシック体","游ゴシック","YuGothic M","メイリオ",Meiryo,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",Symbola}body{margin:0;line-height:1.25;min-width:315px;height:100%;overflow-x:hidden;font-smooth:always;-webkit-font-smoothing:antialiased;padding-top:5rem}wrapper{min-height:100%}main{display:block;margin:0 auto;max-width:800px}header{display:block;margin:0 auto;width:100%;max-width:800px;box-shadow:0 6px 10px -10px rgba(0,0,0,0.7)}footer{display:block;margin:0 auto;width:100%;max-width:800px}.logo{border-radius:80%}.gsearch{width:10rem;max-width:40vw;font-family:"Inconsolata",YuGothic,"游ゴシック体","游ゴシック","YuGothic M","メイリオ",Meiryo,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",Symbola}.title-font{font-family:"Comic Neue","AoyagiKouzanTSubset","Inconsolata",YuGothic,"游ゴシック体","游ゴシック","YuGothic M","メイリオ",Meiryo,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",Symbola}hr{padding:0;margin:8px 0;border:0;height:0;border-top:1px solid rgba(0,0,0,0.1);border-bottom:1px solid rgba(255,255,255,0.8)}.icon-envelope svg,.icon-key svg,.icon-keybase svg,.icon-twitter svg,.icon-facebook svg,.icon-github svg,.icon-mastodon svg,.icon-amp svg{height:1.2rem;width:1.2rem}.icon-envelope{color:#242424}.icon-key{color:#ff8c00}.icon-keybase{color:#ff8c00}.icon-twitter{color:#55acee}.icon-facebook{color:#3B5998}.icon-github{color:#4c4c4c}.icon-mastodon{color:#3B5998}.icon-amp{color:#ff851b}.research li:nth-child(even){background-color:#f5f5f5}.small{font-size:80%}.doi{font-size:80%}#table-of-contents{margin:0;padding:0;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;border-bottom:1px solid rgba(0,0,0,0.1)}#table-of-contents h2{margin:0;padding:0;font-size:1rem;border:none;margin-right:1rem}#table-of-contents h2:after{content:":";padding:0;margin:0}#table-of-contents #text-table-of-contents ul{margin:0;padding:0}#table-of-contents #text-table-of-contents ul li{list-style:none;padding:0;display:inline-block}#table-of-contents #text-table-of-contents ul li+li:before{content:"/ ";padding:0;margin:0;color:#ccc}a{text-decoration:none;color:#3498db}a:hover{text-decoration:underline}@media (max-width: 40rem){body{padding-top:4.8rem}.wrapper{padding:0 .5rem;background-color:#fff}header{padding:0 .5rem;background-color:#fff}header input.navigation-input{display:none}header nav{padding-right:1rem}header div.breadcrumbs{padding-right:1rem}header .navcontents{height:0;padding:0;margin:0;opacity:0;overflow:hidden}header input.navigation-input:checked~.navcontents{position:absolute;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;top:2rem;width:80vw;left:10vw;text-align:right;padding:10px;padding-right:1rem;height:auto;opacity:1;background-color:#fff;box-shadow:0 6px 10px 0 rgba(0,0,0,0.7)}header input.navigation-input:checked~.navcontents div{font-size:1.25rem;margin:10px auto;width:100%;text-align:right}.dmenu input.dmenu-input{display:none;width:0}.dmenu label{text-decoration:none;color:#3498db}.dmenu input.dmenu-input:not(:checked)~.dcontents{display:none}.dmenu input.dmenu-input:checked~.dcontents{opacity:1;background-color:#fff}.dmenu input.dmenu-input:checked~.dcontents ul{background-color:#fff}.page-title{font-size:1.5rem}.icon-envelope svg,.icon-key svg,.icon-keybase svg,.icon-twitter svg,.icon-facebook svg,.icon-github svg,.icon-mastodon svg,.icon-amp svg{height:1.4rem;width:1.4rem}amp-img.profile-picture{height:3rem;width:3rem;position:relative;float:right;border-radius:50%;margin-right:10px;margin-top:-1.2rem;margin-left:1.2rem}#table-of-contents{display:none}footer{padding:0 .5rem}}@media (min-width: 40.06rem) and (max-width: 52.06rem){body{padding-top:4.8rem}.wrapper{padding:0 1rem;background-color:#fff}nav{padding-right:2rem}div.breadcrumbs{padding-right:2rem}header{padding:0 1rem;background-color:#fff}header input.navigation-input{display:none}header .navcontents{height:0;padding:0;margin:0;opacity:0;overflow:hidden}header input.navigation-input:checked~.navcontents{position:absolute;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;top:2rem;width:80vw;left:10vw;text-align:right;padding:10px;padding-right:2rem;height:auto;opacity:1;background-color:#fff;box-shadow:0 6px 10px 0 rgba(0,0,0,0.7)}header input.navigation-input:checked~.navcontents div{font-size:1.25rem;margin:10px auto;width:100%;text-align:right}.dmenu input.dmenu-input{display:none;width:0}.dmenu label{text-decoration:none;color:#3498db}.dmenu input.dmenu-input:not(:checked)~.dcontents{display:none}.dmenu input.dmenu-input:checked~.dcontents{opacity:1;background-color:#fff}.dmenu input.dmenu-input:checked~.dcontents ul{background-color:#fff}amp-img.profile-picture{height:6rem;width:6rem;position:relative;float:right;border-radius:50%;margin-right:10px;margin-top:-1.2rem;margin-left:1.2rem}.icon-envelope svg,.icon-key svg,.icon-keybase svg,.icon-twitter svg,.icon-facebook svg,.icon-github svg,.icon-mastodon svg,.icon-amp svg{height:1.3rem;width:1.3rem}footer{padding:0 1rem}}@media (min-width: 52.06rem) and (max-width: 64rem){body{padding-top:5rem}.wrapper{padding:0 2rem;background-color:#fff}header{padding:0 2rem;background-color:#fff}header .navigation-input{display:none}nav{padding-right:.5rem}div.breadcrumbs{padding-right:.5rem}.dmenu input.dmenu-input{display:none;width:0}.dmenu label{text-decoration:none;color:#3498db}.dmenu .dcontents{position:absolute}.dmenu input.dmenu-input:not(:checked)~.dcontents{display:none}.dmenu input.dmenu-input:checked~.dcontents{opacity:1;background-color:#fff}.dmenu input.dmenu-input:checked~.dcontents ul{background-color:#fff}.icon-envelope svg,.icon-key svg,.icon-keybase svg,.icon-twitter svg,.icon-facebook svg,.icon-github svg,.icon-mastodon svg,.icon-amp svg{height:1.3rem;width:1.3rem}amp-img.profile-picture{height:6rem;width:6rem;position:relative;float:right;border-radius:50%;margin-top:0.9rem;margin-left:0.9rem}footer{padding:0 2rem}}@media (min-width: 64rem){body{padding-top:4rem}.wrapper{padding:0 4rem;background-color:#fff}header{background-color:#fff}header .navigation-input{display:none}.dmenu input.dmenu-input{display:none;width:0}.dmenu label{text-decoration:none;color:#3498db}.dmenu .dcontents{position:absolute}.dmenu input.dmenu-input:not(:checked)~.dcontents{display:none}.dmenu input.dmenu-input:checked~.dcontents{opacity:1;background-color:#fff}.dmenu input.dmenu-input:checked~.dcontents ul{background-color:#fff}amp-img.profile-picture{height:6rem;width:6rem;position:relative;float:right;border-radius:50%;margin-top:0.9rem;margin-left:0.9rem}footer{padding:0 4rem}}table{margin:15px 0;border-collapse:collapse;width:100%;padding:0}table tr{border-top:1px solid #cccccc;background-color:white;margin:0;padding:0}table tr:nth-child(2n){background-color:#f8f8f8}table tr th{font-weight:bold;border:1px solid #cccccc;text-align:left;margin:0;padding:6px 13px}table tr td{border:1px solid #cccccc;text-align:left;margin:0;padding:6px 13px}table tr th :first-child,table tr td :first-child{margin:0}table tr th :last-child,table tr td :last-child{margin:0}pre{font-size:100%;padding:5px 10px;margin:0 auto;color:#020202;background-color:#eeeeff;overflow:auto;border:2px;border-radius:3px;font-family:inherit}code{background-color:#eeeeff;color:#020202;weight:normal;font-family:inherit}figure.highlight{margin:0;padding:0;border:0;font-family:inherit}.highlight{padding:5px 10px;background-color:#eeeeff;color:#f8f8f2;font-family:inherit}.highlight .hll{background-color:#eeeeff}.highlight .c{color:#008800}.highlight .err{border:1px solid #FF0000}.highlight .k{color:#AA22FF;font-weight:bold}.highlight .o{color:#666666}.highlight .cm{color:#008800}.highlight .cp{color:#008800}.highlight .c1{color:#008800}.highlight .cs{color:#008800;font-weight:bold}.highlight .gd{color:#A00000}.highlight .gr{color:#FF0000}.highlight .gh{color:#000080;font-weight:bold}.highlight .gi{color:#00A000}.highlight .go{color:#808080}.highlight .gp{color:#000080;font-weight:bold}.highlight .gs{font-weight:bold}.highlight .gu{color:#800080;font-weight:bold}.highlight .gt{color:#0040D0}.highlight .kc{color:#AA22FF;font-weight:bold}.highlight .kd{color:#AA22FF;font-weight:bold}.highlight .kn{color:#AA22FF;font-weight:bold}.highlight .kp{color:#AA22FF}.highlight .kr{color:#AA22FF;font-weight:bold}.highlight .kt{color:#00BB00;font-weight:bold}.highlight .m{color:#666666}.highlight .s{color:#BB4444}.highlight .na{color:#BB4444}.highlight .nb{color:#AA22FF}.highlight .nc{color:#0000FF}.highlight .no{color:#880000}.highlight .nd{color:#AA22FF}.highlight .ni{color:#999999;font-weight:bold}.highlight .ne{color:#D2413A;font-weight:bold}.highlight .nf{color:#00A000}.highlight .nl{color:#A0A000}.highlight .nn{color:#0000FF;font-weight:bold}.highlight .nt{color:#008000;font-weight:bold}.highlight .nv{color:#B8860B}.highlight .ow{color:#AA22FF;font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mf{color:#666666}.highlight .mh{color:#666666}.highlight .mi{color:#666666}.highlight .mo{color:#666666}.highlight .sb{color:#BB4444}.highlight .sc{color:#BB4444}.highlight .sd{color:#BB4444}.highlight .s2{color:#BB4444}.highlight .se{color:#BB6622;font-weight:bold}.highlight .sh{color:#BB4444}.highlight .si{color:#BB6688;font-weight:bold}.highlight .sx{color:#008000}.highlight .sr{color:#BB6688}.highlight .s1{color:#BB4444}.highlight .ss{color:#B8860B}.highlight .bp{color:#AA22FF}.highlight .vc{color:#B8860B}.highlight .vg{color:#B8860B}.highlight .vi{color:#B8860B}.highlight .il{color:#666666}span.anchor{display:none}.sanchor{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAAAAAA6I3INAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAAAOAAAADgCxW/H3AAAAH0lEQVQI12M4jAIYDv9HAni4hw/Tmgt3E1YuiqtQAAD5Nq+Ne1ON1gAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxMi0wNy0zMVQxNTowNDowNCswOTowMONpTpcAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMDctMTAtMjhUMDc6NDY6MzArMDk6MDAE9UrdAAAAAElFTkSuQmCC);background-position:bottom right;background-repeat:no-repeat;padding:14px 14px 0px 0px;color:#fff;background-color:transparent;font-size:1px}.canchor{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAAAAABzHgM7AAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAAAMAAAADADOpTJ+AAAAIElEQVQI12P4jwQYsHKOHDlCDAe3AVAOSDVcD24OAgAAVIGJOMkyXx4AAAAldEVYdGRhdGU6Y3JlYXRlADIwMTItMDctMzFUMTU6MDM6NTgrMDk6MDCO9TH+AAAAJXRFWHRkYXRlOm1vZGlmeQAyMDA3LTEwLTI4VDA3OjQ2OjMwKzA5OjAwBPVK3QAAAABJRU5ErkJggg==);background-position:bottom right;background-repeat:no-repeat;padding:12px 12px 0px 0px;color:#fff;background-color:transparent;font-size:1px}.mail{display:none}.sanchor:before{display:block;content:" ";margin-top:-110px;height:110px;visibility:hidden}p.source{text-align:right;font-size:80%}p.source cite{font-style:normal}.day h2{font-size:1rem}.comment{display:none}.profile-picture{height:6rem;width:6rem;position:relative;float:right;border-radius:50%;margin-top:-.6rem}.tdiary-profile{width:70%}.tdiary-profile-picture{border-radius:50%}.footer{display:block;margin:0 auto;text-align:right;font-size:80%;width:100%;max-width:800px}.gsearch{max-width:40vw}@media (max-width: 40rem){.footer{padding:0 .5rem}}@media (min-width: 40.06rem) and (max-width: 52.06rem){.footer{padding:0 1rem}}@media (min-width: 52.06rem) and (max-width: 64rem){.footer{padding:0 2rem}}@media (min-width: 64rem){.footer{padding:0 4rem}}*[id]:before{display:block;content:" ";margin-top:-110px;height:110px;visibility:hidden}    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <meta name="author" content="Youhei SASAKI">
    <!-- end: check google site verification -->
    <!-- alternate -->
    <link rel="alternate" hreflang="ja" href="https://uwabami.github.io/cc-env/DebianMail.html" />
    <!-- end: alternate -->
    <!-- begin jekyll seo -->
<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Mail 環境の設定 | Youhei SASAKI’s official site</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Mail 環境の設定" />
<meta name="author" content="Youhei SASAKI" />
<meta property="og:locale" content="ja" />
<meta name="description" content="My Interest: Geophysical Fluid Dynamics, Convection, MHD Dynamo, Numerical Computing, Unix, Linux, Debian" />
<meta property="og:description" content="My Interest: Geophysical Fluid Dynamics, Convection, MHD Dynamo, Numerical Computing, Unix, Linux, Debian" />
<link rel="canonical" href="https://uwabami.github.io/cc-env/DebianMail.html" />
<meta property="og:url" content="https://uwabami.github.io/cc-env/DebianMail.html" />
<meta property="og:site_name" content="Youhei SASAKI’s official site" />
<meta property="og:image" content="https://uwabami.github.io/assets/img/eyecatch_1600x900.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-14T06:59:54+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://uwabami.github.io/assets/img/eyecatch_1600x900.png" />
<meta property="twitter:title" content="Mail 環境の設定" />
<meta name="twitter:site" content="@uwabami" />
<meta name="twitter:creator" content="@Youhei SASAKI" />
<script type="application/ld+json">
{"description":"My Interest: Geophysical Fluid Dynamics, Convection, MHD Dynamo, Numerical Computing, Unix, Linux, Debian","@type":"BlogPosting","image":"https://uwabami.github.io/assets/img/eyecatch_1600x900.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://uwabami.github.io/cc-env/DebianMail.html"},"url":"https://uwabami.github.io/cc-env/DebianMail.html","headline":"Mail 環境の設定","dateModified":"2021-08-14T06:59:54+09:00","datePublished":"2021-08-14T06:59:54+09:00","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://uwabami.github.io/assets/img/eyecatch_1600x900.png"},"name":"Youhei SASAKI"},"author":{"@type":"Person","name":"Youhei SASAKI"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
    <!-- end jekyll seo -->
    <link rel="icon" type="image/x-icon" href="https://uwabami.github.io/assets/img/favicon.ico">
    <!-- apple icons -->
    <link rel="apple-touch-icon" href="https://uwabami.github.io/assets/img/favicon-256x256.png">
    <link rel="shortcut-icon" type="image/ico" href="/assets/img/favicon.ico">
  </head>
  <body>
    <!-- include: gdpr -->
    <amp-geo layout="nodisplay">
      <script type="application/json">
        {
            "ISOCountryGroups": {
                "eu": [ "preset-eea"]
            }
        }
      </script>
    </amp-geo>
    <amp-consent layout="nodisplay" id="consent-element">
      <script type="application/json">
        {
            "consents": {
                "my_consent": {
                    "promptIfUnknownForGeoGroup": "eu",
                    "promptUI": "consent-ui"
                }
            }
        }
      </script>
      <div id="consent-ui">
        I use cookies to analyze how visitors use my website via Google Analytics:
        <button on="tap:consent-element.accept" role="button">Accept</button>
        <button on="tap:consent-element.reject" role="button">Reject</button>
        <button on="tap:consent-element.dismiss" role="button">Dismiss</button>
      </div>
    </amp-consent>
    <!-- end include: gdpr -->
    <div class="wrapper">
      <!-- include: navbar -->
      <header class="container right-0 left-0 top-0 z4 fixed">
        <!-- page loop -->
        <nav class="navigation flex items-center justify-between">
          <div class="pr1 py1 order-0">
            <a href="/index.html">
              <amp-img layout="fixed"
                       width="1.2rem"
                       height="1.2rem"
                       src="/assets/img/top.webp"
                       alt="About"
                       id="top"
                       class="logo left">
                <amp-img fallback
                         layout="fixed"
                         width="1.2rem"
                         height="1.2rem"
                         src="/assets/img/top.jpg"
                         alt="About"
                         id="top"
                         class="logo left">
                </amp-img>
              </amp-img>
            </a>
          </div>
          <input type="checkbox" id="tm" class="navigation-input">
          <label for="tm" class="pl1 py1 order-3 md-hide lg-hide h2">☰</label>
          <div class="navcontents items-center md-flex lg-flex order-1">
          <!-- lang ja -->
            <div class="px1 py0">
              <a href="/research/index.html">
                Research
              </a>
            </div>
            <div class="dmenu px1 py0">
              <input type="checkbox" id="dmenu" class="dmenu-input">
              <label for="dmenu">Software &#9662;</label>
              <div class="dcontents">
                <ul class="list-reset p0 m0">
                  <li class="px1 py0">
                    <a href="/software/index.html">
                      Repository
                    </a>
                  </li>
                  <li class="px1 py0">
                    <a href="/cc-env/index.html">
                      Comp. Memo
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="px1 py1">
              <a href="https://uwabami.junkhub.org/log">blog</a>
            </div>
          </div>
          <div class="flex-auto"></div>
          <div class="px1 py0 order-2">
            <form method="GET"
                  class="p0 m0"
                  action="https://www.google.com/cse"
                  target="_top">
              <div class="inline-block relative p0 m0 small">
                <input name="cx" type="hidden"
                       value="017455171263919107349:oumnpe4bynr" />
                <input name="ie" type="hidden" value="UTF-8" />
                <input class="gsearch" type="search" placeholder="検索" name="q" required>
              </div>
            </form>
          </div>
          
        </nav>
        <div class="breadcrumbs">
          <div class="flex items-center">
            <!-- create crumbs -->
            <div class="pr1 py0">
              <a href="/index.html">
                Top
              </a>
            </div>
            &gt;<div class="px1"><a href="/cc-env/index.html">Cc-env</a></div>      <!-- end page loop -->
            <div class="flex-auto py0"></div>
            <div class="pr0 py0"><!-- end: lang selector -->
            </div>
          </div>
        </div>
      </header>
      <!-- end include: navbar -->
      <main role="main">
        <div class="container content">
          <h1 class="page-title my2 py0 px0">Mail 環境の設定</h1>
          <hr>
<!-- %%%% start content %%%% -->
<nav id="table-of-contents">
<h2>目次</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org02aae9c7">始めに</a></li>
<li><a href="#orgc6ac0121">送信設定: Exim4</a></li>
<li><a href="#org5afde083">送信設定: msmtp</a></li>
<li><a href="#orgbf2f5d08">受信</a></li>
</ul>
</div>
</nav>
<p>
Related <a href="https://uwabami.github.io/cc-env/index.html">Index</a> <a href="index.html#orge0707863">Debian</a>
</p>
<div>
<h2 id="org02aae9c7">始めに</h2>
<div class="outline-text-2" id="text-org02aae9c7">
<p>
メールに関するアレコレ.
ネットワーク接続を意識したくないので,
送受信用のサーバを手元に置いて MUA はなるべくここを叩くようにしている.
</p>
</div>
</div>
<div>
<h2 id="orgc6ac0121">送信設定: Exim4</h2>
<div class="outline-text-2" id="text-orgc6ac0121">
<p>
smarthost での送信だけなら Exim4 が軽量で楽。
他にも幾つか選択肢はある。気になるなら <a href="https://wiki.debian.org/Debate/DefaultMTA">Debian Wiki: DefaultMTA</a> あたり参照のこと。
欲しい機能は
</p>
<ul class="org-ul">
<li>上流の MTA への smarthost 送信。</li>
<li>offline 時の queue</li>
<li>localhost:25 での待受</li>
</ul>
<p>
なので、軽いしとりあえず Exim4 をそのまま使っている。
</p>
<pre class="example">
$ sudo -s
# dpkg-reconfigure -plow exim4-config
  メール設定の一般的なタイプ: 2. スマートホストでメール送信; SMTP または fetchmail で受信する
  システムメール名: localhost
  入力側 SMTP 接続をリスンする IP アドレス: 127.0.0.1
  メールを受け取るその他の宛先: [空白]
  メールをリレーするマシン: [空白]
  送出スマートホストの IP アドレスまたはホスト名: スマートホスト用の送信サーバ::587
  送出するメールでローカルメール名を隠しますか? no
  DNS クエリの数を最小限に留めますか (ダイヤルオンデマンド)? no
  ローカルメールの配送方式: 1. /var/mail/ 内の mbox 形式
  設定を小さなファイルに分割しますか?: no
  root と postmaster のメール受信者: 適当に設定
</pre>
<p>
そのあと, <code>/etc/exim4/passwd.client</code> 内で, スマートホストの設定
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">スマートホスト送信サーバ:[アカウント]:[パスワード]</code></pre></figure>
<p>
そして必要なら <code>/etc/exim4/email-addresses</code> に置換するリストを適当に記述.
最低限 root と ユーザ宛(uid=1000) のメール送信先は設定しておく.
</p>
<pre class="example">
$ sudo -s
# upate-exim4.conf
# sudo /etc/init.d/exim4 restart
</pre>
<p>
あとは適当にテストとかしてみると良い.
</p>

<p>
(2020/04/27) このままだと message-id が "乱数列@hostname" になるので
<code>/etc/exim4/exim4.conf.localmacros</code> に
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">message_id_header_domain</span> = ドメイン名
<span class="n">message_id_header_text</span>   = ホスト名</code></pre></figure>
<p>
を追加して <code>update-exim4.conf</code> を走らせておく.
</p>

<p>
ローカル配送先を適宜設定したい場合には
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">MAILDIR_HOME_MAILDIR_LOCATION</span> = $<span class="n">home</span>/<span class="n">Maildir</span>/<span class="n">INBOX</span></code></pre></figure>
<p>
などとしておく.
</p>
</div>
</div>
<div>
<h2 id="org5afde083">送信設定: msmtp</h2>
<div class="outline-text-2" id="text-org5afde083">
<p>
<a href="/cc-env/Emacs.html#org2c2abb9b">Wanderlust</a> からメールを送る時には,
<code>msmtp</code> を使っている.
</p>

<p>
sendmail コマンド互換かつ enverope-from に応じて送信に利用する
SMTP サーバを切り替えられる, というのが良い.
本当は Gmail に SMTP サーバを登録しておいて, exim4 の smarthost で
Gmail に丸投げしたかったのだけれど,
Gmail のメールサーバは <code>Reply-To</code> を上書きしたりして行儀が良くない.
</p>

<p>
msmtp 自体の設定はいたって普通だが, queue が面倒?
結局 Emacs からは <code>sendmail</code> として
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="nv">ARGS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span>
msmtp-enqueue.sh <span class="nv">$ARGS</span> 1&gt;/dev/null
<span class="k">if</span> <span class="o">[</span> x<span class="s2">"</span><span class="si">$(</span><span class="nv">LANG</span><span class="o">=</span>C nmcli n connectivity<span class="si">)</span><span class="s2">"</span> <span class="o">=</span> x<span class="s2">"full"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>msmtp-runqueue.sh 2&gt;&amp;1 1&gt;/dev/null
<span class="k">fi
</span><span class="nb">exit </span>0</code></pre></figure>
<p>
を叩くことで, ネットワーク接続がある場合には即座に送信,
無い場合には queuing, という風に動作を切り替えている.
</p>

<p>
あとは NetworkManager の dispatcher として msmtp-runqueue を走らせれば良い.
</p>
</div>
</div>
<div>
<h2 id="orgbf2f5d08">受信</h2>
<div class="outline-text-2" id="text-orgbf2f5d08">
<p>
受信/閲覧は
</p>
<ul class="org-ul">
<li>
<a href="http://isync.sourceforge.net/">isync</a> で、リモートの IMAP サーバのメールをローカルに Maildir 形式で保存</li>
<li>ローカルで dovecot-imapd を起動してメールを閲覧</li>
</ul>
<p>
としている.
</p>

<p>
最近の MUA は多かれ少なかれ IMAP 接続でも手元にメールを持ってくるので,
このメールの重複をなんとかしたいのだけれども,
例えば Wanderlust なんかで Maildir を直接見にいくと Emacs の反応があまり芳しくない.
</p>

<p>
以前 <a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0247">第247回 Offlineimap＋Dovecotによる快適メール環境：Ubuntu Weekly Recipe</a> なんて記事を書いた。
その時は offlineimap を使っていたのだけれども
</p>
<ul class="org-ul">
<li>遅い。特に 2014 年あたりから Gmail の同期が体感できるレベルで遅くなった</li>
<li>偶に block するし、imap の接続数が酷い事になる。</li>
</ul>
<p>
ということで、2015 年から <a href="http://isync.sourceforge.net/">isync: free IMAP and MailDir mailbox synchronizer</a> に移行した。
</p>
</div>
<div>
<h3 id="org1b669e8c">
<span class="todo TODO">TODO</span> mbsync/isync</h3>
<div class="outline-text-3" id="text-org1b669e8c">
<p>
isync/mbsync はリモートの IMAP サーバとローカルの Maildir を同期するソフトウェア。
gmail の <code>XOAUTH2</code> に対応するために <a href="https://salsa.debian.org/uwabami/libsasl2-module-xoauth2">libsasl2-module-xoauth2</a> なんてものを
パッケージ化していたりする. ←あとで書く.
</p>
</div>
<div>
<h4 id="org14da667f">インストール: mbsync/isync</h4>
<div class="outline-text-4" id="text-org14da667f">
<p>
実行バイナリは <code>isync</code> もしくは <code>mbsync</code> 。以前の名前が <code>isync</code> なので、Debian のパッケージ名はそのままである。
</p>
<pre class="example">
$ sudo apt-get install isync
</pre>
<p>
apt 万歳
</p>
</div>
</div>
<div>
<h4 id="org2ddeb5a8">設定: mbsync/isync</h4>
<div class="outline-text-4" id="text-org2ddeb5a8">
<p>
設定ファイルは <code>~/.mbsyncrc</code>.
設定例は以下:
</p>
<ul class="org-ul">
<li>
<code>~/Maildir/</code> 以下にサーバのメールを同期する</li>
<li>
<code>~/Maildir/INBOX.mobile.XXX</code> に imap.mobile.com のメールを同期.
<ul class="org-ul">
<li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
</ul>
</li>
<li>
<code>~/Maildir/INBOX.Gmail.XXX</code> に Gmail のメールを同期
<ul class="org-ul">
<li>明示的に <code>Pattern</code> を指定することで、指定ディレクトリ以外を同期しないことにする</li>
<li>
<code>[Gmail]/</code> というラベルを上手く扱えないので、同期チャンネルを複数設定することで対応
<ul class="org-ul">
<li>今のところ SPAM 堕ちしたメールの確認のためだけに <code>~/Maildir/INBOX.Gmail.Junk</code> のみ確認している</li>
</ul>
</li>
</ul>
</li>
<li>
<code>~/Maildir/INBOX</code> に <code>work.example.com</code> のメールを同期
<ul class="org-ul">
<li>
<code>work.example.com</code> メールサーバのディレクトリが <code>work/2014</code> 等と "/" 区切りになっているので <code>Flatten: .</code> で
<code>INBOX.work.2014</code> 等に変換する。そのために <code>MaildirStore</code> を複数設定している</li>
<li>
<code>Pattern: * !*mobile* !*Gmail*</code> で同期から除外する <code>Maildir</code> を指定する</li>
</ul>
</li>
<li>PassCmd で gpg 暗号化した netrc 形式のファイルからパスワードを取得している.
<ul class="org-ul">
<li>これ、User なんかにも使えないかなぁ、とか思ったり</li>
</ul>
</li>
</ul>
<p>
今のところ特に使用に際して困った事はおきていない。
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">IMAPAccount</span> <span class="n">mobile</span>
<span class="n">Host</span> <span class="n">mobile</span>.<span class="n">example</span>.<span class="n">com</span>
<span class="n">User</span> <span class="n">TheMobileUserAccount</span>
<span class="n">PassCmd</span> <span class="s2">"echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine mobile.example.com .*password \\\([^ ]*\\) port.*,\\1,p')}"</span>
<span class="n">Port</span> <span class="m">993</span>
<span class="n">UseIMAPS</span> <span class="n">yes</span>
<span class="n">RequireSSL</span> <span class="n">yes</span>
<span class="n">UseTLSv1</span>.<span class="m">2</span> <span class="n">yes</span>
<span class="n">CertificateFile</span> /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="n">IMAPAccount</span> <span class="n">work</span>
<span class="n">Host</span> <span class="n">work</span>.<span class="n">example</span>.<span class="n">com</span>
<span class="n">User</span> <span class="n">TheWorkUserAccount</span>
<span class="n">PassCmd</span> <span class="s2">"echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine work.example.com .*password \\\([^ ]*\\) port.*,\\1,p')}"</span>
<span class="n">Port</span> <span class="m">993</span>
<span class="n">UseIMAPS</span> <span class="n">yes</span>
<span class="n">RequireSSL</span> <span class="n">yes</span>
<span class="n">UseTLSv1</span>.<span class="m">2</span> <span class="n">yes</span>
<span class="n">CertificateFile</span> /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="n">IMAPAccount</span> <span class="n">gmail</span>
<span class="n">Host</span> <span class="n">imap</span>.<span class="n">gmail</span>.<span class="n">com</span>
<span class="n">User</span> <span class="n">GmailMailAddress</span>
<span class="n">PassCmd</span> <span class="s2">"echo ${PASSWORD:-$(gpg --no-tty -qd ~/.authinfo.gpg | sed -n 's,^machine imap.gmail.com .*password \\\([^ ]*\\) port.*,\\1,p')}"</span>
<span class="n">Port</span> <span class="m">993</span>
<span class="n">UseIMAPS</span> <span class="n">yes</span>
<span class="n">RequireSSL</span> <span class="n">yes</span>
<span class="n">UseTLSv1</span>.<span class="m">2</span> <span class="n">yes</span>
<span class="n">CertificateFile</span> /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="n">IMAPStore</span> <span class="n">work</span>-<span class="n">remote</span>
<span class="n">Account</span> <span class="n">work</span>
<span class="n">UseNamespace</span> <span class="n">no</span>

<span class="n">IMAPStore</span> <span class="n">work</span>-<span class="n">remote</span>
<span class="n">Account</span> <span class="n">work</span>

<span class="n">IMAPStore</span> <span class="n">gmail</span>-<span class="n">remote</span>
<span class="n">Account</span> <span class="n">gmail</span>
<span class="n">UseNamespace</span> <span class="n">yes</span>

<span class="n">MaildirStore</span> <span class="n">local</span>
<span class="n">Path</span> ~/<span class="n">Maildir</span>/
<span class="n">Inbox</span> ~/<span class="n">Maildir</span>/<span class="n">INBOX</span>

<span class="n">MaildirStore</span> <span class="n">work</span>-<span class="n">local</span>
<span class="n">Path</span> ~/<span class="n">Maildir</span>/
<span class="n">Inbox</span> ~/<span class="n">Maildir</span>/<span class="n">INBOX</span>
<span class="n">Flatten</span> .

<span class="n">Channel</span> <span class="n">mobile</span>
<span class="n">Master</span> :<span class="n">mobile</span>-<span class="n">remote</span>:
<span class="n">Slave</span> :<span class="n">local</span>:<span class="n">INBOX</span>.<span class="n">mobile</span>.
<span class="n">Patterns</span> <span class="n">INBOX</span> <span class="n">Junk</span> <span class="n">Archives</span> <span class="n">Sent</span> <span class="n">Drafts</span> <span class="n">Trash</span>
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *

<span class="n">Channel</span> <span class="n">gmail</span>
<span class="n">Master</span> :<span class="n">gmail</span>-<span class="n">remote</span>:
<span class="n">Slave</span> :<span class="n">local</span>:<span class="n">INBOX</span>.<span class="n">Gmail</span>.
<span class="n">Patterns</span> <span class="n">INBOX</span>
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *

<span class="n">Channel</span> <span class="n">gmail</span>-<span class="n">junk</span>
<span class="n">Master</span> <span class="s2">":gmail-remote:[Gmail]/&amp;j,dg0TDhMPww6w-"</span>
<span class="n">Slave</span> :<span class="n">local</span>:<span class="n">INBOX</span>.<span class="n">Gmail</span>.<span class="n">Junk</span>
<span class="n">Patterns</span> *
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *

<span class="n">Channel</span> <span class="n">work</span>
<span class="n">Master</span> :<span class="n">work</span>-<span class="n">remote</span>:
<span class="n">Slave</span> :<span class="n">work</span>-<span class="n">local</span>:
<span class="n">Patterns</span> * !*<span class="n">mobile</span>* !*<span class="n">Gmail</span>*
<span class="n">Create</span> <span class="n">Both</span>
<span class="n">Expunge</span> <span class="n">Both</span>
<span class="n">Sync</span> <span class="n">all</span>
<span class="n">SyncState</span> *</code></pre></figure>
<p>
上手く設定できているなら
</p>
<pre class="example">
mbsync -l mobile
</pre>
<p>
などとして、同期する <code>Maildir</code> を確認すると良い。
リモートとローカルでどういうマッピングがされているかわかるだろう。
25万通(6.5G)の同期にだいたい 3 時間ぐらい。
回線速度に依存するだろうけれど、offlineimap より目に見えて速い(気がする)。
また、IMAP Pipeline で処理されているので、サーバ上の IMAP connection の数は 1 つのみだった。
</p>
</div>
</div>
<div>
<h4 id="orgf55f00fe">cron での動作: mbsync/isync</h4>
<div class="outline-text-4" id="text-orgf55f00fe">
<p>
認証に GPG を使っており、認証に Gnome Keyring を用いているので
必要な環境変数を読み込んでから実行するようにする.
先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意:
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>
<span class="nb">sleep </span>5
<span class="c"># Export the dbus session address on startup so it can be used by cron</span>
<span class="nb">touch</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">chmod </span>600 <span class="nv">$HOME</span>/.Xdbus
<span class="nb">env</span> | <span class="nb">grep </span>DBUS_SESSION_BUS_ADDRESS <span class="o">&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">env</span> | <span class="nb">grep </span>GPG_AGENT_INFO <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">'export DBUS_SESSION_BUS_ADDRESS'</span> <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">'export GPG_AGENT_INFO'</span> <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus</code></pre></figure>
<p>
<code>~/.config/autostart</code> 以下に適当な名前で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">[<span class="n">Desktop</span> <span class="n">Entry</span>]
<span class="n">Type</span>=<span class="n">Application</span>
<span class="n">Exec</span>=/<span class="n">home</span>/<span class="n">uwabami</span>/.<span class="n">mua</span>/<span class="n">export_x_info</span>.<span class="n">sh</span>
<span class="n">Hidden</span>=<span class="n">false</span>
<span class="n">NoDisplay</span>=<span class="n">false</span>
<span class="n">X</span>-<span class="n">GNOME</span>-<span class="n">Autostart</span>-<span class="n">enabled</span>=<span class="n">true</span>
<span class="n">Name</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
<span class="n">Comment</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span></code></pre></figure>
<p>
を用意しておく.
</p>

<p>
あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
必要に応じて GnomeKeyring による認証が行なわれる.
cron で実行されるスクリプトは, 例えば
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="c"># -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-</span>
<span class="c">################################################################################</span>
<span class="c"># for personal settings</span>
<span class="nv">PID</span><span class="o">=</span>~/Maildir/mbsync.pid
<span class="nv">CONF</span><span class="o">=</span>~/.mbsyncrc
<span class="c"># for gnome-keyring:</span>
<span class="nb">.</span> <span class="k">${</span><span class="nv">HOME</span><span class="k">}</span>/.Xdbus
<span class="c"># check network is avaliable</span>
nm-online <span class="nt">-x</span>  2&gt;/dev/null <span class="o">||</span> <span class="nb">exit </span>0
<span class="c"># check another offlineimap</span>
timelimit <span class="nt">-T</span> 300 <span class="nt">-t</span> 300 mbsync <span class="nt">-c</span> <span class="nv">$CONF</span> <span class="nt">-a</span> 2&gt;&amp;1 <span class="o">||</span> <span class="nb">exit </span>0</code></pre></figure>
<p>
とか。mbsync 自体の timeout や PID  管理ができないので、 <code>timelinit</code> コマンドで処理をするようにしている。
実際は、二回目以降の同期は(回線速度に依存するだろうけれど) 20 秒ぐらい。
</p>
</div>
</div>
</div>
<div>
<h3 id="org4a294ad8">dovecot</h3>
<div class="outline-text-3" id="text-org4a294ad8">
</div>
<div>
<h4 id="orge30e9132">インストール: dovecot</h4>
<div class="outline-text-4" id="text-orge30e9132">
<p>
最低限 IMAP での接続ができれば良いので
</p>
<pre class="example">
% sudo apt-get install dovecot-imapd
</pre>
<p>
apt 万歳
</p>
</div>
</div>
<div>
<h4 id="org003785b7">設定: dovecot</h4>
<div class="outline-text-4" id="text-org003785b7">
<p>
最低限の設定として、
</p>
<ul class="org-ul">
<li>localhost で起動. 認証は PAM に任せる(login パスワードと同じ)</li>
<li>Maildir 形式で mbsync(もしくは offlineimap)で同期したMaildirを読む.</li>
<li>IMAP もしくは IMAP over SSL のみ</li>
</ul>
<p>
ための設定を行なう
</p>

<p>
以下、設定ファイル中のコメント行を除いた部分だけを記載しているので注意
(コメント消すなんてとんでもない!)。
</p>

<p>
先ず待受サーバ。
どの IP アドレスで待ち受けるかは <code>/etc/dovecot/dovecot.conf</code> にあるので
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">...
<span class="n">listen</span> = <span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span>
...</code></pre></figure>
<p>
あたりを修正しておく。
</p>

<p>
認証は
<code>/etc/dovecot/conf.d/10-auth.conf</code> 内で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">disable_plain_text_auth</span> = <span class="n">no</span>
<span class="n">auth_mechanisms</span> = <span class="n">plain</span>
!<span class="n">include</span> <span class="n">auth</span>-<span class="n">system</span>.<span class="n">conf</span>.<span class="n">ext</span></code></pre></figure>
<p>
を有効に。include されている auth-system.conf.ext の中身は
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">passdb</span> {
  <span class="n">driver</span> = <span class="n">pam</span>
}
<span class="n">userdb</span> {
  <span class="n">driver</span> = <span class="n">passwd</span>
}</code></pre></figure>
<p>
だけが有効。これで pam 経由でパスワードログインするようになる.
</p>

<p>
次に Maildir の設定。 <code>/etc/dovecot/conf.d/10-mail.conf</code> 内で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">mail_location</span> = <span class="n">maildir</span>:%<span class="n">h</span>/<span class="n">Maildir</span>:<span class="n">INBOX</span>=%<span class="n">h</span>/<span class="n">Maildir</span>/<span class="n">INBOX</span>:<span class="n">LAYOUT</span>=<span class="n">fs</span>
<span class="n">namespace</span> <span class="n">inbox</span> {
  <span class="n">inbox</span> = <span class="n">yes</span>
}</code></pre></figure>
<p>
あたりを修正しておく。
</p>

<p>
最後に IMAP over SSL の設定。 <code>/etc/dovecot/conf.d/10-ssl.conf</code> で証明書の設定をする:
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">ssl_cert</span> = &lt;/<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">private</span>/<span class="n">ssl</span>-<span class="n">cert</span>-<span class="n">dovecot</span>.<span class="n">pem</span>
<span class="n">ssl_key</span> = &lt;/<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">private</span>/<span class="n">ssl</span>-<span class="n">cert</span>-<span class="n">dovecot</span>.<span class="n">key</span>
<span class="n">ssl_protocols</span> = !<span class="n">SSLv2</span> !<span class="n">SSLv3</span></code></pre></figure>
<p>
その後に <code>/etc/dovecot/conf.d/10-master.conf</code> 内の <code>imap-login</code> 部分を修正
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">service</span> <span class="n">imap</span>-<span class="n">login</span> {
  <span class="n">inet_listener</span> <span class="n">imap</span> {
    <span class="n">port</span> = <span class="m">0</span>
    <span class="n">ssl</span> = <span class="n">no</span>
  }
  <span class="n">inet_listener</span> <span class="n">imaps</span> {
    <span class="n">port</span> = <span class="m">993</span>
    <span class="n">ssl</span> = <span class="n">yes</span>
  }
}</code></pre></figure>
<p>
これで再起動すると <code>/etc/ssl/private</code> に置いた SSL 証明書を使って <code>127.0.1.1:993</code> で IMAP サーバが起動する。Listen を 127.0.0.1 に絞るなら SSL でのアクセスは不要かもしれない。
</p>
</div>
</div>
</div>
<div>
<h3 id="org9d74f665">以下, obsolete</h3>
<div class="outline-text-3" id="text-org9d74f665">
<p>
検索は mu (maildir-utils) を使うようになったし,
メールの同期には mbsync を使うようになったので, 以下は昔のお話.
</p>
</div>
<div>
<h4 id="org7b190bb8">検索: Solr</h4>
<div class="outline-text-4" id="text-org7b190bb8">
<p>
Dovecot には FTS(Full Text Search) 用の plugin が幾つかある。
ここでは Solr を試してみる
</p>

<p>
とりあえず jetty で solar を動かすことに:
</p>
<pre class="example">
% sudo aptitude -R solr-jetty dovecot-solr
</pre>

<p>
Jetty の起動設定は <code>/etc/default/jetty8</code> にあるので
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">NO_START</span>=<span class="m">0</span>
<span class="n">JETTY_HOST</span>=<span class="n">localhost</span>
<span class="n">JETTY_PORT</span>=<span class="m">8089</span></code></pre></figure>
<p>
としておく。dovecot 用の scheme.xml は <code>dovecot-solr</code> をインストールすると <code>/usr/share/dovecot/solr-scheme.xml</code> にインストールされるので、これを <code>/etc/solr/conf/scheme.xml</code> にコピー
</p>
<pre class="example">
% cd /etc/solr/conf
% sudo cp scheme.xml scheme.xml.bak
% sudo cp /usr/share/dovecot/solr-schemex.ml scheme.xml
</pre>
<p>
その後で <code>/etc/dovecot/conf.d/10-imap.conf</code> 内の mail<sub>plugins</sub> 行に
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">mail_plugins</span> = <span class="n">fts</span> <span class="n">fts_solr</span></code></pre></figure>
<p>
を追加しておく。
IMAP でしか使わないのであれば <code>20-imap.conf</code> に指定すれば良いのだが、この場合は <code>doveadm fts rescan -u USERNAME</code> ができない。
最後に <code>/etc/dovecot/conf.d/90-plugin.conf</code> で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">plugin</span> {
  <span class="n">fts_autoindex</span> = <span class="n">yes</span>
  <span class="n">fts</span> = <span class="n">solr</span>
  <span class="n">fts_solr</span> = <span class="n">break</span>-<span class="n">imap</span>-<span class="n">search</span> <span class="n">url</span>=<span class="n">http</span>://<span class="n">localhost</span>:<span class="m">8089</span>/<span class="n">solr</span>/
}</code></pre></figure>
<p>
としておく。これで jetty8 および dovecot を再起動すると、検索が効く様になる…?
</p>
</div>
</div>
<div>
<h4 id="orgc1f4a23a">検索: Solr で日本語</h4>
<div class="outline-text-4" id="text-orgc1f4a23a">
<p>
<code>scheme.xml</code> の修正が必要。
とりあえず
</p>
<ul class="org-ul">
<li>
<code>/etc/solr/conf/scheme.xml</code> より <code>text_cjk</code> および <code>text_ja</code> の部分を抜き出して, dovecot の提供していた <code>scheme.xml</code> に追加</li>
<li>
<code>hdr,body,subject</code> を <code>text_cjk</code> で解析するように</li>
</ul>
<p>
してみた.
</p>

<p>
diff は以下:
</p>
<figure class="highlight"><pre><code class="language-diff" data-lang="diff"><span class="gd">--- solr-schema.xml 2015-05-10 20:52:33.375358006 +0900
</span><span class="gi">+++ schema.xml  2015-05-10 20:37:37.358195292 +0900
</span><span class="p">@@ -13,6 +13,62 @@</span>
     &lt;fieldType name="long" class="solr.TrieLongField" /&gt;
     &lt;fieldType name="boolean" class="solr.BoolField" /&gt;

+    &lt;!-- CJK bigram (see text_ja for a Japanese configuration using morphological analysis) --&gt;
<span class="gi">+    &lt;fieldType name="text_cjk" class="solr.TextField" positionIncrementGap="100"&gt;
+      &lt;analyzer&gt;
+        &lt;tokenizer class="solr.StandardTokenizerFactory"/&gt;
+        &lt;!-- normalize width before bigram, as e.g. half-width dakuten combine  --&gt;
+        &lt;filter class="solr.CJKWidthFilterFactory"/&gt;
+        &lt;!-- for any non-CJK --&gt;
+        &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
+        &lt;filter class="solr.CJKBigramFilterFactory"/&gt;
+      &lt;/analyzer&gt;
+    &lt;/fieldType&gt;
+    &lt;fieldType name="text_ja" class="solr.TextField" positionIncrementGap="100" autoGeneratePhraseQueries="false"&gt;
+      &lt;analyzer&gt;
+      &lt;!-- Kuromoji Japanese morphological analyzer/tokenizer (JapaneseTokenizer)
+
+           Kuromoji has a search mode (default) that does segmentation useful for search.  A heuristic
+           is used to segment compounds into its parts and the compound itself is kept as synonym.
+
+           Valid values for attribute mode are:
+              normal: regular segmentation
+              search: segmentation useful for search with synonyms compounds (default)
+            extended: same as search mode, but unigrams unknown words (experimental)
+
+           For some applications it might be good to use search mode for indexing and normal mode for
+           queries to reduce recall and prevent parts of compounds from being matched and highlighted.
+           Use &lt;analyzer type="index"&gt; and &lt;analyzer type="query"&gt; for this and mode normal in query.
+
+           Kuromoji also has a convenient user dictionary feature that allows overriding the statistical
+           model with your own entries for segmentation, part-of-speech tags and readings without a need
+           to specify weights.  Notice that user dictionaries have not been subject to extensive testing.
+
+           User dictionary attributes are:
+                     userDictionary: user dictionary filename
+             userDictionaryEncoding: user dictionary encoding (default is UTF-8)
+
+           See lang/userdict_ja.txt for a sample user dictionary file.
+
+           See http://wiki.apache.org/solr/JapaneseLanguageSupport for more on Japanese language support.
+        --&gt;
+        &lt;tokenizer class="solr.JapaneseTokenizerFactory" mode="search"/&gt;
+        &lt;!--&lt;tokenizer class="solr.JapaneseTokenizerFactory" mode="search" userDictionary="lang/userdict_ja.txt"/&gt;--&gt;
+        &lt;!-- Reduces inflected verbs and adjectives to their base/dictionary forms (辞書形) --&gt;
+        &lt;filter class="solr.JapaneseBaseFormFilterFactory"/&gt;
+        &lt;!-- Removes tokens with certain part-of-speech tags --&gt;
+        &lt;filter class="solr.JapanesePartOfSpeechStopFilterFactory" tags="lang/stoptags_ja.txt" enablePositionIncrements="true"/&gt;
+        &lt;!-- Normalizes full-width romaji to half-width and half-width kana to full-width (Unicode NFKC subset) --&gt;
+        &lt;filter class="solr.CJKWidthFilterFactory"/&gt;
+        &lt;!-- Removes common tokens typically not useful for search, but have a negative effect on ranking --&gt;
+        &lt;filter class="solr.StopFilterFactory" ignoreCase="true" words="lang/stopwords_ja.txt" enablePositionIncrements="true" /&gt;
+        &lt;!-- Normalizes common katakana spelling variations by removing any last long sound character (U+30FC) --&gt;
+        &lt;filter class="solr.JapaneseKatakanaStemFilterFactory" minimumLength="4"/&gt;
+        &lt;!-- Lower-cases romaji characters --&gt;
+        &lt;filter class="solr.LowerCaseFilterFactory"/&gt;
+      &lt;/analyzer&gt;
+    &lt;/fieldType&gt;
+
</span>     &lt;fieldType name="text" class="solr.TextField" positionIncrementGap="100"&gt;
       &lt;analyzer type="index"&gt;
         &lt;tokenizer class="solr.StandardTokenizerFactory"/&gt;
<span class="p">@@ -43,14 +99,14 @@</span>
    &lt;field name="box" type="string" indexed="true" stored="true" required="true" /&gt;
    &lt;field name="user" type="string" indexed="true" stored="true" required="true" /&gt;

-   &lt;field name="hdr" type="text" indexed="true" stored="false" /&gt;
<span class="gd">-   &lt;field name="body" type="text" indexed="true" stored="false" /&gt;
</span><span class="gi">+   &lt;field name="hdr" type="text_cjk" indexed="true" stored="false" /&gt;
+   &lt;field name="body" type="text_cjk" indexed="true" stored="false" /&gt;
</span>
    &lt;field name="from" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="to" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="cc" type="text" indexed="true" stored="false" /&gt;
    &lt;field name="bcc" type="text" indexed="true" stored="false" /&gt;
<span class="gd">-   &lt;field name="subject" type="text" indexed="true" stored="false" /&gt;
</span><span class="gi">+   &lt;field name="subject" type="text_cjk" indexed="true" stored="false" /&gt;
</span>
    &lt;!-- Used by Solr internally: --&gt;
    &lt;field name="_version_" type="long" indexed="true" stored="true"/&gt;</code></pre></figure>
</div>
</div>
<div>
<h4 id="org56239831">offlineimap</h4>
<div class="outline-text-4" id="text-org56239831">
<p>
(2015/05/10) 以前使っていた時のメモ。もう使わないけれど、たまに検索でココを見に来ている人がいるみたいなので、残しておくことに。
<a href="http://offlineimap.org/">OfflineIMAP</a> は,ネットワーク上にあるIMAPサーバと手元のMaildir/IMAPサーバの同期を取るためのソフトウェア.
</p>
</div>
<ul class="org-ul">
<li>インストール: offlineimap<br>
<div class="outline-text-5" id="text-org9a0058d3">
<p>
apt万歳, ってことで.
</p>
<pre class="example">
$ sudo apt-get install offlineimap
</pre>
</div>
</li>
<li>設定: offlineimap<br>
<div class="outline-text-5" id="text-org9ebeeb17">
<p>
現状, 以下の通り:
</p>
<ul class="org-ul">
<li>
<a href="http://offlineimap.org/">OfflineIMAP</a> のメタ情報は <code>~/Mail/offlineimap</code> 以下に格納</li>
<li>同期するサーバは二箇所:
<ul class="org-ul">
<li>Main サーバのメールは <code>~/Mail/imap</code> 以下に格納.
<ul class="org-ul">
<li>この際, IMAP Namespace である <code>INBOX.</code> を除外して <code>Maildir</code> を作成</li>
<li>
<code>~/Mail/imap/[Gmail]</code> は同期しない</li>
</ul>
</li>
<li>Gmail のメールは <code>~/Mail/imap/[Gmail]/</code> 以下に格納</li>
</ul>
</li>
</ul>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="c"># -*- mode: conf; coding: utf-8-unix; indent-tabs-mode: nil -*-
# offlineimaprc
#
# Copyright(C) 2011 Youhei SASAKI All rights reserved.
# $Lastupdate: 2014-07-26 18:25:07$
#
# Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;
# License: WTFPL
#
# Code:
</span>[<span class="n">general</span>]
<span class="c"># メタデータの格納先
</span><span class="n">metadata</span> = ~/<span class="n">Mail</span>/<span class="n">offlineimap</span>
<span class="c"># 補助関数が定義されたファイルの置き場所
</span><span class="n">pythonfile</span> = ~/.<span class="n">mua</span>/<span class="n">offlineimap_utils</span>.<span class="n">py</span>
<span class="c"># 同期するサーバの設定
</span><span class="n">accounts</span> = <span class="n">Main</span>, <span class="n">Gmail</span>
<span class="c"># 同期するアカウントの数
</span><span class="n">maxsyncaccounts</span> = <span class="m">2</span>
<span class="c"># UI の設定. cron で同期する場合には quiet の方が良い
</span><span class="n">ui</span> = <span class="n">basic</span>
<span class="n">socktimeout</span> = <span class="m">600</span>
<span class="c"># 高速化(?)
</span><span class="n">fsync</span> = <span class="n">false</span>

<span class="c"># Gmail 用の設定: ここで設定する名前は accounts に揃える
</span>[<span class="n">Account</span> <span class="n">Gmail</span>]
<span class="n">localrepository</span> = <span class="n">LocalGmail</span>
<span class="n">remoterepository</span> = <span class="n">RemoteGmail</span>
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">status_backend</span> = <span class="n">sqlite</span>
<span class="c"># quick = 1 だとフラグは同期されない
# '[Gmail]/全てのメール' を同期するなら quick = 1 の方が良い?
</span><span class="n">quick</span> = <span class="m">0</span>

[<span class="n">Repository</span> <span class="n">LocalGmail</span>]
<span class="c"># Gmail の手元の設定
</span><span class="n">type</span> = <span class="n">Maildir</span>
<span class="c"># Maildir の格納場所
</span><span class="n">localfolders</span> = ~/<span class="n">Mail</span>/<span class="n">imap</span>/[<span class="n">Gmail</span>]
<span class="n">restoreatime</span> = <span class="n">no</span>
<span class="c"># IMAP のセパレータの変換: Mailbox の "." が "/" となり,
# ディレクトリが作成される
</span><span class="n">sep</span> = /

[<span class="n">Repository</span> <span class="n">RemoteGmail</span>]
<span class="c"># Gmail との接続設定: type = IMAP でも良い?
</span><span class="n">type</span> = <span class="n">Gmail</span>
<span class="c"># remote{pass,user}eval は offlineimap_utils.py で定義した関数
</span><span class="n">remoteusereval</span> = <span class="n">get_username</span>(<span class="s2">"imap.gmail.com"</span>)
<span class="n">remotepasseval</span> = <span class="n">get_password</span>(<span class="s2">"imap.gmail.com"</span>)
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">realdelete</span> = <span class="n">no</span>
<span class="c"># 同時接続数. 並列実行可能なので適宜
# サーバに怒られない程度に
</span><span class="n">maxconnections</span> = <span class="m">5</span>
<span class="c"># remote -&gt; local 時のフォルダ名変換(正規表現)
</span><span class="n">nametrans</span> = <span class="n">lambda</span> <span class="n">foldername</span>: <span class="n">re</span>.<span class="n">sub</span>(<span class="s1">'^INBOX'</span>,<span class="s1">''</span>, (<span class="n">re</span>.<span class="n">sub</span>(<span class="s1">'^\[Gmail\]/'</span>,<span class="s1">''</span>, <span class="n">foldername</span>)))
<span class="c"># 同期するフォルダの設定: Gmail 側で IMAP で表示するラベル設定しておく, でも良いかも.
</span><span class="n">folderfilter</span> = <span class="n">lambda</span> <span class="n">foldername</span>: <span class="n">foldername</span> <span class="n">in</span> [
             <span class="s1">'INBOX'</span>,                   <span class="c"># -&gt; '~/Mail/imap/[Gmail]' になる
</span>             <span class="s1">'[Gmail]/&amp;j,dg0TDhMPww6w-'</span> <span class="c"># -&gt; '~/Mail/imap/[Gmail]/&amp;j,dg0TDhMPww6w-' になる
</span>             ]
<span class="n">sslcacertfile</span> = /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>

<span class="c"># Main サーバの設定: ここで設定する名前は [general] accounts に揃える
</span>[<span class="n">Account</span> <span class="n">Main</span>]
<span class="n">localrepository</span> = <span class="n">LocalMain</span>
<span class="n">remoterepository</span> = <span class="n">RemoteMain</span>
<span class="n">status_backend</span> = <span class="n">sqlite</span>
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">quick</span> = <span class="m">0</span>

[<span class="n">Repository</span> <span class="n">LocalMain</span>]
<span class="c"># 手元の設定
</span><span class="n">type</span> = <span class="n">Maildir</span>
<span class="c"># Maildir の格納場所
</span><span class="n">localfolders</span> = ~/<span class="n">Mail</span>/<span class="n">imap</span>
<span class="n">restoreatime</span> = <span class="n">no</span>
<span class="c"># local -&gt; remote での名前変換
# LocaltoRemoteTransnameINBOX は offlineimap_utils.py で定義した関数
</span><span class="n">nametrans</span> = <span class="n">LocalToRemoteTransnameINBOX</span>
<span class="c"># 'Maildir/imap/[Gmail]' は同期しない
</span><span class="n">folderfilter</span> = <span class="n">lambda</span> <span class="n">folder</span>: <span class="n">not</span> <span class="n">folder</span>.<span class="n">startswith</span>(<span class="s1">'[Gmail]'</span>)
<span class="n">sep</span> = /

[<span class="n">Repository</span> <span class="n">RemoteMain</span>]
<span class="n">type</span> = <span class="n">IMAP</span>
<span class="n">ssl</span> = <span class="n">yes</span>
<span class="c"># certificates がデフォルトで探せない?
</span><span class="n">sslcacertfile</span> = /<span class="n">etc</span>/<span class="n">ssl</span>/<span class="n">certs</span>/<span class="n">ca</span>-<span class="n">certificates</span>.<span class="n">crt</span>
<span class="n">remotehost</span> = [<span class="n">main</span> <span class="n">server</span>]
<span class="c"># remote{pass,user}eval は offlineimap_utils.py で定義した関数
</span><span class="n">remoteusereval</span> = <span class="n">get_username</span>(<span class="s2">"[main server]"</span>)
<span class="n">remotepasseval</span> = <span class="n">get_password</span>(<span class="s2">"[main server]"</span>)
<span class="n">maxsize</span> = <span class="m">2000000000</span>
<span class="n">maxconnections</span> = <span class="m">5</span>
<span class="c"># remote -&gt; local での名前の変換
# RemotetoLocalTransnameINBOX は offlineimap_utils.py で定義した関数
</span><span class="n">nametrans</span> = <span class="n">RemoteToLocalTransnameINBOX</span>
<span class="c"># 同期 *しない* フォルダの選択
</span><span class="n">folderfilter</span> = <span class="n">lambda</span> <span class="n">foldername</span>: <span class="n">foldername</span> <span class="n">not</span> <span class="n">in</span> [
            <span class="s1">'INBOX.Drafts'</span>,
            <span class="s1">'INBOX.Trash'</span>,
            <span class="s1">'INBOX.archive.zz2006'</span>,
            <span class="s1">'INBOX.archive.zz2007'</span>,
            <span class="s1">'INBOX.archive.zz2008'</span>,
            <span class="s1">'INBOX.archive.zz2009'</span>,
            <span class="s1">'INBOX.archive.zz2010'</span>,
            <span class="s1">'INBOX.archive.zz2011'</span>,
            <span class="s1">'INBOX.archive.zz2012'</span>,
            <span class="s1">'INBOX.archive.zz2013'</span>
            ]</code></pre></figure>
<p>
<code>offlineimap_utils.py</code> の中身は以下の通り:
</p>
<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python
# -*- coding: utf-8
</span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># # Auth via GnomeKeyring
</span><span class="kn">import</span> <span class="nn">gtk</span>
<span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">import</span> <span class="nn">gnomekeyring</span> <span class="k">as</span> <span class="n">gkey</span>
<span class="c1"># Ad hoc fix for Striptime behavior
</span><span class="kn">import</span> <span class="nn">locale</span>
<span class="n">locale</span><span class="p">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="p">.</span><span class="n">LC_TIME</span><span class="p">,</span> <span class="s">'C'</span><span class="p">)</span>

<span class="c1">##################
# Gnome keyring  #
##################
</span>
<span class="k">class</span> <span class="nc">Keyring</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">protocol</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_keyring</span> <span class="o">=</span> <span class="n">gkey</span><span class="p">.</span><span class="n">get_default_keyring_sync</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"server"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_server</span><span class="p">,</span> <span class="s">"protocol"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_protocol</span><span class="p">}</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">gkey</span><span class="p">.</span><span class="n">find_items_sync</span><span class="p">(</span><span class="n">gkey</span><span class="p">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="n">gkey</span><span class="p">.</span><span class="n">DeniedError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"server"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_server</span><span class="p">,</span> <span class="s">"protocol"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_protocol</span><span class="p">}</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">gkey</span><span class="p">.</span><span class="n">find_items_sync</span><span class="p">(</span><span class="n">gkey</span><span class="p">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">attributes</span><span class="p">[</span><span class="s">"user"</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">secret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"user"</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                <span class="s">"server"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_server</span><span class="p">,</span>
                <span class="s">"protocol"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_protocol</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">gkey</span><span class="p">.</span><span class="n">item_create_sync</span><span class="p">(</span><span class="n">gkey</span><span class="p">.</span><span class="n">get_default_keyring_sync</span><span class="p">(),</span>
                <span class="n">gkey</span><span class="p">.</span><span class="n">ITEM_NETWORK_PASSWORD</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_username</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">keyring</span> <span class="o">=</span> <span class="n">Keyring</span><span class="p">(</span><span class="s">"offlineimap"</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s">"imap"</span><span class="p">)</span>
    <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=</span> <span class="n">keyring</span><span class="p">.</span><span class="n">get_credentials</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">username</span>

<span class="k">def</span> <span class="nf">get_password</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">keyring</span> <span class="o">=</span> <span class="n">Keyring</span><span class="p">(</span><span class="s">"offlineimap"</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s">"imap"</span><span class="p">)</span>
    <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=</span> <span class="n">keyring</span><span class="p">.</span><span class="n">get_credentials</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">password</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
        <span class="n">server</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">"server: "</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">"username: "</span><span class="p">)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s">"password: "</span><span class="p">)</span>
        <span class="n">confirm</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="s">"confirm password: "</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">confirm</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"password doesn't match confirmation!"</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">keyring</span> <span class="o">=</span> <span class="n">Keyring</span><span class="p">(</span><span class="s">"offlineimap"</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="s">"imap"</span><span class="p">)</span>
        <span class="n">keyring</span><span class="p">.</span><span class="n">set_credentials</span><span class="p">((</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

<span class="c1">############################
# NameTrans 'INBOX' suffix #
############################
# add 'INBOX' suffix
</span><span class="k">def</span> <span class="nf">LocalToRemoteTransnameINBOX</span><span class="p">(</span><span class="n">foldername</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">foldername</span> <span class="o">==</span> <span class="s">""</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">"INBOX"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">"INBOX."</span> <span class="o">+</span> <span class="n">foldername</span>
    <span class="k">return</span> <span class="n">retval</span>

<span class="c1"># remove 'INBOX' suffix
</span><span class="k">def</span> <span class="nf">RemoteToLocalTransnameINBOX</span><span class="p">(</span><span class="n">foldername</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">foldername</span> <span class="o">==</span> <span class="s">"INBOX"</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"^INBOX\."</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">foldername</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retval</span></code></pre></figure>
<p>
IMAP の名前空間が複雑な(?)場合には, 適宜正規表現を追加すると良い.
</p>
</div>
</li>
<li>cron での動作: offlineimap<br>
<div class="outline-text-5" id="text-org79b6cb1b">
<p>
認証に GnomeKeyring を使っているので <code>DBUS_SESSION_BUS_ADDRESS</code> を設定してから
実行するようにする.
先ず <code>~/bin/export_x_info.sh</code> を以下の内容で用意
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>
<span class="nb">sleep </span>5
<span class="c"># Export the dbus session address on startup so it can be used by cron</span>
<span class="nb">touch</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">chmod </span>600 <span class="nv">$HOME</span>/.Xdbus
<span class="nb">env</span> | <span class="nb">grep </span>DBUS_SESSION_BUS_ADDRESS <span class="o">&gt;</span> <span class="nv">$HOME</span>/.Xdbus
<span class="nb">echo</span> <span class="s1">'export DBUS_SESSION_BUS_ADDRESS'</span> <span class="o">&gt;&gt;</span> <span class="nv">$HOME</span>/.Xdbus</code></pre></figure>
<p>
<code>~/.config/autostart</code> 以下に適当な名前で
</p>
<figure class="highlight"><pre><code class="language-conf" data-lang="conf">[<span class="n">Desktop</span> <span class="n">Entry</span>]
<span class="n">Type</span>=<span class="n">Application</span>
<span class="n">Exec</span>=/<span class="n">home</span>/<span class="n">uwabami</span>/.<span class="n">mua</span>/<span class="n">export_x_info</span>.<span class="n">sh</span>
<span class="n">Hidden</span>=<span class="n">false</span>
<span class="n">NoDisplay</span>=<span class="n">false</span>
<span class="n">X</span>-<span class="n">GNOME</span>-<span class="n">Autostart</span>-<span class="n">enabled</span>=<span class="n">true</span>
<span class="n">Name</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span>
<span class="n">Comment</span>=<span class="n">Xdbus</span> <span class="n">infomation</span> <span class="n">exporter</span></code></pre></figure>
<p>
を用意しておく.
</p>

<p>
あとは cron 実行時に <code>~/.Xdbus</code> を include するようにしておけば,
必要に応じて GnomeKeyring による認証が行なわれる.
cron で実行されるスクリプトは, 例えば
</p>
<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/sh</span>
<span class="c"># -*- mode:sh; coding: utf-8-unix; indent-tabs-mode: nil -*-</span>
<span class="c"># $Lastupdate: 2014-07-15 11:52:22$</span>
<span class="c"># Author: Youhei SASAKI &lt;uwabami@gfd-dennou.org&gt;</span>
<span class="c"># License: WTFPL</span>
<span class="c">################################################################################</span>
<span class="c"># for personal settings</span>
<span class="nv">OFFLINEIMAP_PID</span><span class="o">=</span>~/Mail/offlineimap/pid
<span class="nv">OFFLINEIMAP_CONF</span><span class="o">=</span>~/.offlineimaprc
<span class="nv">UI</span><span class="o">=</span>quiet
<span class="nb">echo</span> <span class="s2">"******************************************************************"</span>
<span class="nb">echo</span> <span class="sb">`</span><span class="nv">LANG</span><span class="o">=</span>C <span class="nb">date</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"******************************************************************"</span>
<span class="c"># for gnome-keyring:</span>
<span class="nb">.</span> <span class="k">${</span><span class="nv">HOME</span><span class="k">}</span>/.Xdbus
<span class="c"># check network is avaliable</span>
nm-online <span class="nt">-x</span> <span class="o">||</span> <span class="nb">exit </span>0
<span class="c"># check another offlineimap</span>
<span class="o">[</span> <span class="si">$(</span>ps <span class="nt">-p</span> <span class="sb">`</span><span class="nb">cat</span> <span class="nv">$OFFLINEIMAP_PID</span><span class="sb">`</span> <span class="nt">-o</span> pid <span class="nt">--no-heading</span><span class="si">)</span> <span class="o">]</span> <span class="se">\</span>
  <span class="o">||</span> <span class="nb">nice</span> <span class="nt">-n</span> 19 offlineimap <span class="nt">-c</span> <span class="nv">$OFFLINEIMAP_CONF</span> <span class="nt">-u</span> <span class="nv">$UI</span> <span class="nt">-o</span>  2&gt;&amp;1</code></pre></figure>
<p>
とか.
</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<!-- %%%% end content %%%% -->
        </div>
      </main>
      <!-- include footer -->
      <footer class="container bottom-0 left-0 right-0 small">
        <hr/>
        <p class="p0 m0 right-align">&copy; 2006-2021
          <a href="mailto:uwabami@gfd-dennou.org">Youhei SASAKI</a>,
          Lastupdate: 2021-08-13 21:59:54 +0000
          <br/>
          Powered by
          <a href="https://orgmode.org/" rel="noopener" title="Org mode">
            Org mode
          </a>
          +
          <a href="https://jekyllrb.com/" rel="noopener" title="Jekyll">
            Jekyll
          </a>
          +
          <a href="https://basscss.com/" rel="noopener" title="Basscss">
            Basscss
          </a>
          &amp;
          <a href="https://amp.dev/">
            <span class="icon-amp">⚡</span>AMP
          </a>
        </p>
      </footer>
      <amp-analytics data-block-on-consent
                     type="gtag"
                     data-credentials="include">
        <script type="application/json">
          {
              "vars" : {
                  "gtag_id": "UA-90872419-1",
                  "config" : {
                      "UA-90872419-1": { "groups": "default" }
                  }
              }
          }
        </script>
      </amp-analytics>
      <!-- end: include footer -->
    </div>
  </body>
</html>
